# Matrix 符号化工具 - 使用指南

## 📖 目录

1. [快速开始](#快速开始)
2. [详细使用步骤](#详细使用步骤)
3. [界面说明](#界面说明)
4. [常见问题](#常见问题)
5. [高级技巧](#高级技巧)

---

## 快速开始

### 第一步：打开应用

在 Xcode 中构建并运行项目：

```bash
cd MatrixTestApp/MatrixSymbolicator
open MatrixSymbolicator.xcodeproj
```

按 `⌘R` 运行应用。

### 第二步：准备文件

您需要两个文件：

1. **dSYM 文件** (`.dSYM.zip`)
   - 位置: `matrix-symbolicate-server/dsyms/`
   - 示例: `20260103_180622_MatrixTestApp.dSYM.zip`

2. **错误日志** (`.json`)
   - 位置: `matrix-symbolicate-server/reports/`
   - 示例: `1767434772633665000_lag_report_1_1767434772.json`

### 第三步：上传并符号化

1. 将 dSYM 文件拖拽到左侧"符号表文件"区域
2. 将 JSON 文件拖拽到"错误日志"区域
3. 点击"开始符号化"按钮
4. 等待几秒钟，右侧显示符号化结果

---

## 详细使用步骤

### 1. 上传 dSYM 文件

#### 方式一：拖拽上传

1. 从 Finder 中找到 `.dSYM.zip` 文件
2. 拖拽到应用左侧的"符号表文件"区域
3. 松开鼠标，文件自动加载

#### 方式二：点击选择

1. 点击"符号表文件"上传区域
2. 在弹出的文件选择框中选择 `.dSYM.zip` 文件
3. 点击"打开"

#### 确认上传成功

上传成功后会显示：
```
✅ 文件名: 20260103_180622_MatrixTestApp.dSYM.zip
   UUID: 1A2B3C4D-5E6F-7A8B-9C0D-1E2F3A4B5C6D
```

### 2. 上传错误日志

#### 方式一：拖拽上传

1. 从 Finder 中找到 `.json` 文件
2. 拖拽到"错误日志"区域
3. 松开鼠标

#### 方式二：点击选择

1. 点击"错误日志"上传区域
2. 选择 JSON 文件
3. 点击"打开"

#### 确认上传成功

上传成功后会显示：
```
✅ 文件名: 1767434772633665000_lag_report_1_1767434772.json
   类型: 主线程卡顿
   线程数: 15
```

### 3. 开始符号化

点击"开始符号化"按钮后：

1. **处理阶段** (2-5 秒)
   ```
   🔍 开始符号化...
   ✅ dSYM 已解压
   ⚡ 正在符号化线程...
   ```

2. **完成阶段**
   - 右侧显示格式化的符号化结果
   - 可以滚动查看完整内容

### 4. 查看结果

#### 结果格式

```
================================================================================
🔍 Matrix 卡顿报告 - 符号化版本
================================================================================

📱 系统信息:
   应用名称: MatrixTestApp
   系统版本: iOS 17.0
   设备型号: iPhone15,2

📊 符号化统计:
   总线程数: 15
   总帧数: 234
   符号化帧数: 187
   Swift 符号: 45
   ObjC 符号: 52
   应用代码帧: 23
   成功率: 79.9%

================================================================================
🎯 主线程: Thread 0
================================================================================

🟦  0  MatrixTestApp              0x102a3c4b8 [Swift]
      TestSwiftViewController.fibonacci(_:) -> Swift.Int (TestSwiftViewController.swift:65)

🟧  1  MatrixTestApp              0x102a3d120 [Objective-C]
      -[TestLagViewController triggerStackOverflow] (TestLagViewController.mm:156)

   2  UIKitCore                  0x1a2b3c4d8 -[UIViewController viewDidLoad]

   3  UIKitCore                  0x1a2b3c5e0 -[UIApplication sendAction:to:from:forEvent:]
```

#### 图例说明

- 🟦 **Swift 应用代码**: 您的 Swift 代码
- 🟧 **Objective-C 应用代码**: 您的 ObjC/ObjC++ 代码
- **无标记**: 系统库代码

### 5. 导出和复制

#### 复制到剪贴板

1. 点击右上角"复制"按钮
2. 结果已复制到剪贴板
3. 可以粘贴到任何文本编辑器

#### 导出为文件

1. 点击右上角"导出"按钮
2. 选择保存位置
3. 输入文件名（默认: `symbolicated_report.txt`）
4. 点击"保存"

---

## 界面说明

### 左侧面板

#### 1. 符号表文件区域

```
┌─────────────────────────────────┐
│  📦 符号表文件 (.dSYM.zip)      │
│  ┌───────────────────────────┐  │
│  │  拖拽或点击选择 dSYM.zip  │  │
│  │  支持 .dSYM.zip 文件      │  │
│  └───────────────────────────┘  │
│                                  │
│  UUID: 1A2B3C4D-5E6F-7A8B...  ❌│
└─────────────────────────────────┘
```

- **主要功能**: 上传符号表
- **支持格式**: `.dSYM.zip`
- **状态显示**: UUID、文件名
- **快捷操作**: 点击 ❌ 清除文件

#### 2. 错误日志区域

```
┌─────────────────────────────────┐
│  📄 错误日志 (JSON)              │
│  ┌───────────────────────────┐  │
│  │  拖拽或点击选择 JSON 文件 │  │
│  │  支持 .json 格式          │  │
│  └───────────────────────────┘  │
│                                  │
│  类型: 主线程卡顿             ❌│
│  15 个线程                      │
└─────────────────────────────────┘
```

- **主要功能**: 上传错误日志
- **支持格式**: `.json`
- **状态显示**: 报告类型、线程数
- **快捷操作**: 点击 ❌ 清除文件

#### 3. 控制按钮

```
┌─────────────────────────────────┐
│   [ 🪄 开始符号化 ]              │
└─────────────────────────────────┘
```

- **激活条件**: 两个文件都已上传
- **处理中状态**: 显示进度动画
- **完成后**: 自动跳转到结果区

### 右侧面板

#### 工具栏

```
┌─────────────────────────────────────────┐
│  符号化结果     [ 📋 复制 ] [ 📤 导出 ] │
└─────────────────────────────────────────┘
```

- **复制**: 复制结果到剪贴板
- **导出**: 保存为 .txt 文件

#### 结果显示区

- **滚动查看**: 垂直和水平滚动
- **文本选择**: 可以选择任意文本复制
- **字体**: 等宽字体，便于阅读代码
- **自动换行**: 根据窗口宽度调整

---

## 常见问题

### Q1: UUID 无法提取

**症状**:
```
UUID: 无法提取 UUID
```

**原因**:
- dSYM 文件损坏
- 不是有效的 .dSYM.zip 文件
- 缺少 DWARF 调试信息

**解决方案**:
```bash
# 1. 验证 dSYM 文件
dwarfdump --uuid /path/to/app.dSYM

# 2. 重新导出 dSYM
# 在 Xcode 中: Product > Archive > Export > Export for Debugging

# 3. 确保勾选了"Include symbols"
```

### Q2: 符号化失败

**症状**:
```
符号化失败: 符号化失败
```

**原因**:
- dSYM UUID 与报告不匹配
- 架构不匹配（arm64 vs x86_64）
- atos 工具不可用

**解决方案**:

1. **检查 UUID 匹配**:
```bash
# 查看 dSYM UUID
dwarfdump --uuid app.dSYM

# 查看报告中的 UUID（在 binary_images 中）
cat report.json | grep -A 5 "MatrixTestApp"
```

2. **检查架构**:
```json
// 报告中的架构信息
"system": {
  "cpu_arch": "arm64",  // 或 "x86_64"
  ...
}
```

3. **验证 atos**:
```bash
which atos
# 应该输出: /usr/bin/atos
```

### Q3: 报告格式错误

**症状**:
```
无法解析
```

**原因**:
- JSON 格式不正确
- 不是 Matrix 生成的报告

**解决方案**:
```bash
# 1. 验证 JSON 格式
cat report.json | python3 -m json.tool

# 2. 检查文件类型
file report.json
# 应该输出: report.json: JSON data

# 3. 查看文件开头
head -n 20 report.json
```

### Q4: 应用崩溃

**症状**:
应用启动后立即崩溃

**原因**:
- macOS 版本过低
- 权限不足
- 磁盘空间不足

**解决方案**:

1. **检查系统版本**:
```bash
sw_vers
# ProductVersion: 13.0 或更高
```

2. **重置权限**:
```bash
xattr -cr /path/to/MatrixSymbolicator.app
```

3. **检查磁盘空间**:
```bash
df -h
# 确保有至少 1GB 可用空间
```

---

## 高级技巧

### 1. 批量处理

虽然应用不支持批量处理，但您可以：

1. 准备多个报告文件
2. 逐个上传并符号化
3. 使用"导出"功能保存每个结果

### 2. 快速切换文件

处理多个报告时：

1. 符号化完成后，点击 ❌ 清除文件
2. 上传新文件
3. 再次点击"开始符号化"

### 3. 查看原始 JSON

如果需要查看原始数据：

```bash
# 使用 JSON 格式化工具
cat report.json | python3 -m json.tool | less

# 或使用在线工具
open https://jsonformatter.org/
```

### 4. 对比符号化前后

```bash
# 1. 导出符号化结果
#    使用应用的"导出"功能

# 2. 查看原始堆栈
grep -A 50 "backtrace" report.json

# 3. 对比
diff original_stack.txt symbolicated_report.txt
```

### 5. 自动化脚本

如果需要命令行处理，可以使用服务端版本：

```bash
# 使用 Go 服务端
cd matrix-symbolicate-server
./matrix-server

# 通过 API 上传和符号化
curl -F "file=@report.json" http://localhost:8080/api/report/upload
curl -X POST http://localhost:8080/api/report/symbolicate \
  -H "Content-Type: application/json" \
  -d '{"report_id": "1234567890", "dsym_file": "app.dSYM.zip"}'
```

### 6. 性能优化

处理大型报告时：

- **关闭其他应用**: 释放内存
- **使用 SSD**: 加快文件解压速度
- **减少线程数**: 如果报告有很多线程，可以手动编辑 JSON 只保留关键线程

### 7. 调试技巧

如果遇到问题，可以启用详细日志：

1. 在 Xcode 中运行应用
2. 查看控制台输出
3. 关键日志:
   ```
   🔍 开始符号化...
   ✅ dSYM 已解压: /tmp/...
   📍 架构: arm64
   📍 加载地址: 0x100000000
   ✅ [Swift] 符号化成功 (耗时: 15ms)
   ```

---

## 📞 获取帮助

- **GitHub Issues**: [提交问题](https://github.com/Tencent/matrix/issues)
- **文档**: [完整文档](../README.md)
- **服务端版本**: [Go 服务端说明](../matrix-symbolicate-server/使用说明.md)

---

**更新日期**: 2026-01-16  
**版本**: 1.0.0
