# Matrix 符号化工具 - 项目说明

## 🎯 项目目标

将原本基于 Go + Web 的服务端符号化服务，改造为独立的 macOS 桌面应用，提供更便捷的本地符号化能力。

## ✨ 核心特性

### 1. 原生 macOS 体验

- **SwiftUI 界面**: 现代化的原生 UI
- **拖拽上传**: 支持文件拖拽操作
- **实时反馈**: 即时显示处理进度
- **键盘快捷键**: 支持 macOS 标准快捷键

### 2. 高效符号化

- **本地处理**: 无需部署服务器
- **快速响应**: 通常 2-5 秒完成
- **准确率高**: 使用系统 `atos` 工具
- **支持多架构**: arm64 / x86_64

### 3. 完善的功能

- **UUID 自动提取**: 自动验证符号表
- **报告类型识别**: 自动识别卡顿/崩溃/OOM 等
- **详细统计**: 显示符号化成功率、语言分布
- **结果导出**: 支持复制和文件导出

## 📊 技术架构

### 架构图

```
┌─────────────────────────────────────────┐
│         ContentView (SwiftUI)           │
│    ┌──────────────┐   ┌──────────────┐ │
│    │  上传区域    │   │  结果显示    │ │
│    │  FileDropZone│   │  ScrollView  │ │
│    └──────────────┘   └──────────────┘ │
└────────────┬────────────────────────────┘
             │
             ↓
┌────────────────────────────────────────┐
│     SymbolicatorViewModel (@MainActor)  │
│  • 状态管理 (Published Properties)      │
│  • 文件选择 (NSOpenPanel)               │
│  • 导出复制                             │
└────────────┬───────────────────────────┘
             │
             ↓
┌────────────────────────────────────────┐
│    SymbolicationEngine (Actor)         │
│  ┌──────────────────────────────────┐  │
│  │ 1. extractDsym()                 │  │
│  │    - 解压 .dSYM.zip              │  │
│  │    - 提取 DWARF 文件             │  │
│  ├──────────────────────────────────┤  │
│  │ 2. parseReport()                 │  │
│  │    - 解析 JSON 报告              │  │
│  │    - 提取线程和堆栈              │  │
│  ├──────────────────────────────────┤  │
│  │ 3. symbolicateThreads()          │  │
│  │    - 遍历所有线程                │  │
│  │    - 符号化每个地址              │  │
│  ├──────────────────────────────────┤  │
│  │ 4. symbolicateAddress()          │  │
│  │    - 调用 atos 工具              │  │
│  │    - 解析符号信息                │  │
│  ├──────────────────────────────────┤  │
│  │ 5. formatReport()                │  │
│  │    - 生成格式化输出              │  │
│  │    - 添加语言标记                │  │
│  └──────────────────────────────────┘  │
└─────────────┬──────────────────────────┘
              │
              ↓
┌─────────────────────────────────────────┐
│        系统工具 (Process)                │
│  • /usr/bin/atos      (符号化地址)      │
│  • /usr/bin/dwarfdump (提取 UUID)       │
│  • /usr/bin/unzip     (解压 dSYM)       │
└─────────────────────────────────────────┘
```

### 数据流

```
用户操作
   ↓
[1] 拖拽 dSYM.zip
   ↓
   VM.dsymFile = URL
   ↓
   Engine.extractDsymUUID() 
   ↓
   Process(dwarfdump --uuid)
   ↓
   VM.dsymUUID = "ABC-123..."

[2] 拖拽 report.json
   ↓
   VM.reportFile = URL
   ↓
   parseReportInfo()
   ↓
   VM.reportType = "主线程卡顿"
   VM.reportThreadCount = 15

[3] 点击"开始符号化"
   ↓
   VM.symbolicate()
   ↓
   Engine.symbolicate(reportURL, dsymURL)
   ↓
   ① extractDsym(dsymURL)
      → Process(unzip)
      → 查找 DWARF 文件
   ↓
   ② 解析 JSON 报告
      → 提取线程数组
      → 提取堆栈地址
   ↓
   ③ 对每个地址调用 atos
      → Process(atos -arch arm64 -o binary -l 0x100000000 0x102a3c4b8)
      → 解析输出: "TestViewController.viewDidLoad() (Test.swift:42)"
   ↓
   ④ 构建数据模型
      → SymbolicatedThread
      → SymbolicatedFrame
   ↓
   ⑤ 格式化输出
      → 添加 🟦 🟧 标记
      → 计算统计信息
   ↓
   VM.symbolicatedReport = SymbolicatedReport
   VM.formattedReport = "格式化的文本"
   ↓
   ContentView 自动刷新显示
```

## 🔍 核心算法

### 1. dSYM 解压与查找

```swift
actor SymbolicationEngine {
    func extractDsym(_ url: URL) async throws -> String {
        // 1. 创建临时目录
        let tempDir = FileManager.default.temporaryDirectory
            .appendingPathComponent("MatrixSymbolicator_\(UUID())")
        
        // 2. 解压 zip 文件
        Process: unzip -o dsym.zip -d tempDir
        
        // 3. 递归查找 DWARF 文件
        遍历 tempDir/**/*.dSYM/Contents/Resources/DWARF/*
        
        // 4. 返回二进制文件路径
        return dwarfBinaryPath
    }
}
```

### 2. 地址符号化

```swift
func symbolicateAddress(
    address: UInt64,
    binaryPath: String,
    loadAddress: UInt64,
    architecture: String
) async throws -> String {
    // 构建 atos 命令
    let cmd = [
        "atos",
        "-arch", "arm64",
        "-o", "/tmp/app.dSYM/Contents/Resources/DWARF/MatrixTestApp",
        "-l", "0x100000000",  // 加载地址
        "0x102a3c4b8"         // 目标地址
    ]
    
    // 执行并解析输出
    let output = Process.run(cmd)
    
    // 输出示例:
    // "TestSwiftViewController.fibonacci(_:) -> Swift.Int (in MatrixTestApp) (TestSwiftViewController.swift:65)"
    
    return parsedSymbol
}
```

### 3. 语言检测

```swift
func detectLanguage(from symbol: String) -> String {
    // Swift: $s, _$s, $S, _$S 开头
    if symbol.hasPrefix("$s") || symbol.hasPrefix("_$s") {
        return "Swift"
    }
    
    // Objective-C: -[ 或 +[ 开头
    if symbol.hasPrefix("-[") || symbol.hasPrefix("+[") {
        return "Objective-C"
    }
    
    // C++: _Z 开头（mangled name）
    if symbol.hasPrefix("_Z") {
        return "C++"
    }
    
    // 其他: C 或未知
    return "C"
}
```

### 4. 文件信息解析

```swift
func parseFileInfo(from symbol: String) -> (String?, Int?) {
    // 正则表达式匹配文件名和行号
    let pattern = "\\(([^)]+\\.(m|mm|swift|c|cpp|h)):(\\d+)\\)"
    
    // 输入: "func() (TestViewController.swift:65)"
    // 输出: ("TestViewController.swift", 65)
    
    return (fileName, lineNumber)
}
```

## 📦 项目文件说明

### 核心文件

| 文件 | 作用 | 代码量 |
|------|------|--------|
| `MatrixSymbolicatorApp.swift` | 应用入口 | ~30 行 |
| `ContentView.swift` | 主界面 UI | ~280 行 |
| `SymbolicatorViewModel.swift` | 视图模型 | ~150 行 |
| `SymbolicationEngine.swift` | 符号化引擎 | ~650 行 |

### 配置文件

| 文件 | 作用 |
|------|------|
| `Info.plist` | 应用配置（名称、版本、文档类型）|
| `MatrixSymbolicator.entitlements` | 权限配置（文件访问）|
| `project.pbxproj` | Xcode 项目配置 |
| `Assets.xcassets/` | 图标和颜色资源 |

### 文档文件

| 文件 | 作用 |
|------|------|
| `README.md` | 项目简介和功能说明 |
| `快速开始.md` | 一分钟上手指南 |
| `使用指南.md` | 详细使用说明（故障排查、高级技巧）|
| `项目说明.md` | 技术架构和实现细节 |

## 🆚 与服务端版本对比

| 维度 | macOS 应用 | Go 服务端 |
|------|-----------|----------|
| **部署** | 直接运行 .app | 需要启动 HTTP 服务器 |
| **依赖** | macOS 13.0+ | Go 1.19+, atos, dwarfdump |
| **界面** | 原生 SwiftUI | Web HTML/CSS/JS |
| **性能** | ⚡⚡⚡ 极快 | ⚡⚡ 快 |
| **并发** | 单用户 | 多用户并发 |
| **存储** | 临时文件 | 持久化存储 |
| **网络** | 无需网络 | 需要 HTTP 访问 |
| **适用场景** | 个人开发调试 | 团队协作、CI/CD |

## 🛠 技术选型理由

### 为什么选择 SwiftUI？

1. **原生性能**: 直接使用 macOS 原生框架
2. **开发效率**: 声明式 UI，代码简洁
3. **响应式**: 自动状态管理和 UI 更新
4. **现代化**: Apple 官方推荐的 UI 框架

### 为什么使用 Actor？

```swift
actor SymbolicationEngine {
    // Actor 提供线程安全的并发处理
    func symbolicate() async throws -> SymbolicatedReport {
        // 自动序列化访问，避免数据竞争
    }
}
```

优势：
- 自动线程安全
- 避免数据竞争
- 现代并发模型

### 为什么调用系统 `atos`？

1. **准确性**: Apple 官方工具，最准确
2. **完整性**: 自动处理 Swift/ObjC/C++ demangle
3. **维护性**: 跟随系统更新
4. **兼容性**: 支持最新 Xcode 版本

## 📈 性能指标

### 符号化速度

| 报告大小 | 线程数 | 堆栈帧数 | 处理时间 |
|---------|--------|---------|---------|
| 小 | 5 | 50 | 1-2 秒 |
| 中 | 15 | 200 | 2-5 秒 |
| 大 | 30 | 500 | 5-10 秒 |

### 内存占用

- **空闲**: ~50 MB
- **处理中**: ~80-120 MB
- **峰值**: ~150 MB

### dSYM 支持

- ✅ .dSYM.zip 文件
- ✅ arm64 架构
- ✅ x86_64 架构
- ✅ Universal Binary

## 🔐 安全性

### App Sandbox

应用运行在沙盒中，仅请求必要权限：

```xml
<key>com.apple.security.app-sandbox</key>
<true/>
<key>com.apple.security.files.user-selected.read-only</key>
<true/>
<key>com.apple.security.files.user-selected.read-write</key>
<true/>
```

### 数据隐私

- **本地处理**: 所有数据仅在本地处理
- **临时文件**: 处理完自动清理
- **无网络**: 不发送任何数据到外部

## 🚀 未来规划

### 短期计划（v1.1）

- [ ] 支持批量处理
- [ ] 添加处理历史记录
- [ ] 支持深色模式优化
- [ ] 添加快捷键支持

### 中期计划（v1.2）

- [ ] 支持 .crash 文件格式
- [ ] 集成崩溃分析工具
- [ ] 添加堆栈对比功能
- [ ] 支持自定义主题

### 长期计划（v2.0）

- [ ] 支持 OOM 内存溢出分析
- [ ] 集成内存泄漏检测
- [ ] 添加性能分析报告
- [ ] 支持插件系统

## 📞 联系方式

- **GitHub**: [Tencent/matrix](https://github.com/Tencent/matrix)
- **Issues**: [提交问题](https://github.com/Tencent/matrix/issues)
- **Wiki**: [官方文档](https://github.com/Tencent/matrix/wiki)

---

**项目作者**: Matrix Team  
**创建日期**: 2026-01-16  
**当前版本**: 1.0.0  
**许可证**: 与 Matrix 主项目一致
