# 符号表上传工具使用指南 📦

本目录包含两个自动上传 dSYM 符号表到服务器的脚本。

## 🚀 快速使用

### 方法 1：Shell 脚本（推荐）

```bash
cd /Users/momo/Desktop/MatrixTestApp
./upload_dsym.sh
```

### 方法 2：Python 脚本（功能更强大）

```bash
cd /Users/momo/Desktop/MatrixTestApp
./upload_dsym.py
```

或者：
```bash
python3 upload_dsym.py
```

## ✨ 功能特性

### 自动化功能
- ✅ 自动查找 DerivedData 中的所有 dSYM
- ✅ 自动识别最新的 dSYM（按编译时间）
- ✅ 自动提取 UUID 和架构信息
- ✅ 自动打包成 zip 格式
- ✅ 自动上传到服务器
- ✅ 自动清理临时文件

### 交互功能
- 🎯 显示所有找到的 dSYM
- 🎯 可以选择要上传的版本
- 🎯 实时显示上传进度
- 🎯 彩色输出，清晰易读

### 安全功能
- 🔒 上传前检查服务器连接
- 🔒 验证 dSYM 文件有效性
- 🔒 错误处理和友好提示

## 📖 详细说明

### 脚本对比

| 特性 | Shell 脚本 | Python 脚本 |
|------|-----------|-------------|
| 依赖 | 仅需 bash, curl | 需要 Python 3 + requests |
| 速度 | 快 | 稍慢 |
| 跨平台 | macOS/Linux | macOS/Linux/Windows |
| 错误处理 | 基础 | 完善 |
| 输出格式 | 彩色文本 | 彩色文本 + JSON |

### 工作流程

```
1. 检查服务器连接
   ↓
2. 查找 DerivedData 中的 dSYM
   ↓
3. 显示所有找到的 dSYM（按时间排序）
   ↓
4. 用户选择（或自动选择最新的）
   ↓
5. 提取 UUID 和架构信息
   ↓
6. 打包成 zip 文件
   ↓
7. 上传到服务器
   ↓
8. 清理临时文件
   ↓
9. 显示结果
```

## 🎯 使用场景

### 场景 1：编译后立即上传

```bash
# 在 Xcode 中编译完成后
# Xcode: Cmd+B

# 立即上传最新的 dSYM
./upload_dsym.sh
```

### 场景 2：选择特定版本上传

```bash
# 运行脚本
./upload_dsym.py

# 会显示所有版本：
#   [1] /path/to/Debug-iphonesimulator/xxx.dSYM (最新)
#   [2] /path/to/Debug-iphoneos/xxx.dSYM
#   [3] /path/to/Release-iphonesimulator/xxx.dSYM

# 输入数字选择
请选择要上传的 dSYM [1-3] (默认: 1 最新): 2
```

### 场景 3：自定义服务器地址

```bash
# 设置环境变量
export MATRIX_SERVER_URL=http://192.168.1.100:8080

# 运行脚本
./upload_dsym.sh
```

或者：

```bash
# 一次性设置
MATRIX_SERVER_URL=http://192.168.1.100:8080 ./upload_dsym.sh
```

## 💻 输出示例

### 成功场景

```
🚀 Matrix 符号表上传工具
================================

📡 检查服务器连接...
✅ 服务器运行正常

🔍 查找 MatrixTestApp 的 dSYM...
✅ 找到 3 个 dSYM 文件

  [1] /Users/momo/Library/Developer/Xcode/DerivedData/MatrixTestApp-xxx/Build/Products/Debug-iphonesimulator/MatrixTestApp.app.dSYM
      编译时间: 2023-12-22 14:30:45 (最新)
  [2] /Users/momo/Library/Developer/Xcode/DerivedData/MatrixTestApp-xxx/Build/Products/Debug-iphoneos/MatrixTestApp.app.dSYM
      编译时间: 2023-12-22 10:15:20

请选择要上传的 dSYM [1-2] (默认: 1 最新): 

📦 准备上传的 dSYM:
   路径: /Users/momo/Library/Developer/.../MatrixTestApp.app.dSYM

🔍 提取 UUID...
✅ UUID: FD7CB3D0-06EF-3582-9C99-432ABD79F29C
✅ 架构: arm64

📦 打包 dSYM...
✅ 文件大小: 45.23 MB
   临时文件: /var/folders/.../MatrixTestApp.dSYM.zip

📤 上传到服务器...
   服务器: http://localhost:8080
✅ 上传成功！

📋 服务器信息:
   UUID: FD7CB3D0-06EF-3582-9C99-432ABD79F29C
   架构: arm64
   大小: 47458304 bytes

✅ 🎉 完成！
💡 查看符号表: http://localhost:8080/#dsyms
```

### 失败场景

**服务器未运行：**
```
📡 检查服务器连接...
❌ 无法连接到服务器: http://localhost:8080
💡 请先启动服务器:
   cd matrix-symbolicate-server
   ./start.sh
```

**未找到 dSYM：**
```
🔍 查找 MatrixTestApp 的 dSYM...
❌ 未找到 dSYM 文件

💡 请确保:
   1. 已在 Xcode 中编译过应用 (Cmd+B)
   2. Build Settings → Debug Information Format = DWARF with dSYM
   3. DerivedData 未被清理

DerivedData 路径: /Users/momo/Library/Developer/Xcode/DerivedData
```

## 🔧 配置选项

### 环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `MATRIX_SERVER_URL` | 服务器地址 | `http://localhost:8080` |

### 修改应用名称

如果你的应用不叫 MatrixTestApp，需要修改脚本：

**Shell 脚本：**
```bash
# 在 upload_dsym.sh 的第 14 行
APP_NAME="YourAppName"  # 修改这里
```

**Python 脚本：**
```python
# 在 upload_dsym.py 的第 13 行
APP_NAME = "YourAppName"  # 修改这里
```

## 🐛 故障排查

### 问题：权限被拒绝

```bash
# 给脚本添加执行权限
chmod +x upload_dsym.sh
chmod +x upload_dsym.py
```

### 问题：Python 脚本缺少依赖

```bash
# 安装 requests 库
pip3 install requests
```

### 问题：找不到 dSYM

**解决方法：**
1. 在 Xcode 中重新编译（Cmd+B）
2. 检查 Build Settings：
   - Debug Information Format = **DWARF with dSYM File**
   - Strip Debug Symbols = **NO** (Debug 模式)
3. 检查 DerivedData 路径：
   ```bash
   ls ~/Library/Developer/Xcode/DerivedData/MatrixTestApp-*/Build/Products/*/
   ```

### 问题：上传失败

**可能原因：**
1. 服务器未运行
2. 网络连接问题
3. 文件太大（超过 500MB）
4. 磁盘空间不足

**解决方法：**
```bash
# 1. 检查服务器
curl http://localhost:8080/api/health

# 2. 检查磁盘空间
df -h

# 3. 查看服务器日志
cd matrix-symbolicate-server
tail -f server.log
```

## 💡 使用技巧

### 技巧 1：创建别名

在 `~/.zshrc` 或 `~/.bash_profile` 中添加：

```bash
alias upload-dsym='cd /Users/momo/Desktop/MatrixTestApp && ./upload_dsym.sh'
```

然后在任何地方都可以运行：
```bash
upload-dsym
```

### 技巧 2：自动上传（Xcode Build Phase）

在 Xcode 中添加 Build Phase：

1. Project Settings → Target → Build Phases
2. 点击 + → New Run Script Phase
3. 添加脚本：

```bash
# 仅在 Debug 模式下上传
if [ "${CONFIGURATION}" == "Debug" ]; then
    /Users/momo/Desktop/MatrixTestApp/upload_dsym.sh
fi
```

### 技巧 3：批量上传

如果有多个 dSYM 要上传：

```bash
# 自动上传所有找到的 dSYM
for i in {1..5}; do
    echo $i | ./upload_dsym.py
    sleep 2
done
```

### 技巧 4：真机测试

如果使用真机测试，设置真机的 IP：

```bash
export MATRIX_SERVER_URL=http://192.168.1.100:8080
./upload_dsym.sh
```

## 📚 相关文档

- [符号化服务器使用指南](matrix-symbolicate-server/README.md)
- [快速测试指南](QUICK_TEST.md)
- [iOS 自动上报功能](CHANGELOG_LOG_UPLOAD.md)

## 🎉 总结

使用符号表上传工具，你可以：
- ✅ 一键上传 dSYM，无需手动操作
- ✅ 自动查找和选择正确的版本
- ✅ 实时查看上传进度和结果
- ✅ 与符号化服务器完美集成

---

**开始使用：** `./upload_dsym.sh` 🚀

