# Matrix 符号化服务使用指南 📖

这是一份详细的使用指南，帮助你快速上手使用符号化服务。

## 🎯 什么是符号化服务？

符号化服务可以将 Matrix 框架生成的卡顿日志中的内存地址转换为可读的函数名、文件名和行号，帮助你快速定位性能问题。

**举个例子：**

符号化前（看不懂）：
```
0x102abc123
```

符号化后（一目了然）：
```
-[TestLagViewController simulateLag] (TestLagViewController.mm:145)
```

## 📋 准备工作

### 1. 启动服务（只需做一次）

打开终端，进入服务目录：

```bash
cd /Users/momo/Desktop/MatrixTestApp/matrix-symbolicate-server
./start.sh
```

看到以下提示表示成功：
```
🚀 Matrix 符号化服务启动在端口 8080
📱 访问地址: http://localhost:8080
```

> 💡 提示：保持这个终端窗口开着，服务会一直运行。

### 2. 打开 Web 界面

在浏览器中访问：**http://localhost:8080**

你会看到一个漂亮的紫色渐变界面 🎨

## 📤 第一步：上传符号表

### 什么是符号表？

符号表（dSYM）包含了应用的调试信息，是进行符号化的必需文件。

### 如何获取符号表？

**方法 A：从 DerivedData 获取（推荐）**

1. 在 Xcode 中运行一次应用（Cmd+R）
2. 打开终端，执行：

```bash
# 找到最新的构建目录
cd ~/Library/Developer/Xcode/DerivedData

# 查找 MatrixTestApp
ls -lt | grep MatrixTestApp | head -1

# 进入对应目录（替换 xxxxx）
cd MatrixTestApp-xxxxx/Build/Products/Debug-iphonesimulator/

# 打包 dSYM
zip -r ~/Desktop/MatrixTestApp.dSYM.zip MatrixTestApp.app.dSYM
```

3. 现在桌面上有了 `MatrixTestApp.dSYM.zip` 文件

**方法 B：直接使用 .app 文件**

```bash
# 复制整个 .app 文件
cp -r MatrixTestApp.app ~/Desktop/
```

### 上传步骤

1. 在 Web 界面，点击「📤 上传」标签
2. 找到「1️⃣ 上传符号表 (dSYM)」区域
3. 拖拽或点击上传刚才准备的文件
4. 等待上传完成，会显示 UUID（一串字母数字）

✅ 成功提示：`符号表上传成功！UUID: FD7CB3D0-...`

## 📄 第二步：获取卡顿日志

### 从应用中触发卡顿

1. 在 Xcode 中运行 MatrixTestApp（Cmd+R）
2. 点击「Matrix 功能演示」
3. 点击「卡顿监控」
4. 点击「模拟主线程卡顿」
5. 等待 3-5 秒

### 找到日志文件

**在模拟器上：**

```bash
# 方法 1: 使用命令行
xcrun simctl get_app_container booted com.tencent.MatrixTestApp data

# 这会显示一个路径，例如：
# /Users/momo/Library/Developer/CoreSimulator/Devices/XXX/data/Containers/Data/Application/YYY

# 进入 Documents 目录
cd /Users/momo/Library/Developer/CoreSimulator/Devices/XXX/data/Containers/Data/Application/YYY/Documents/Matrix/

# 查找最新的 JSON 文件
ls -lt *.json | head -1

# 复制到桌面
cp xxx.json ~/Desktop/lag_report.json
```

**在真机上：**

1. 在 Xcode 中：Window → Devices and Simulators
2. 选择你的设备
3. 在已安装的 App 列表中找到 MatrixTestApp
4. 点击齿轮图标 → Download Container
5. 保存后，右键 → Show Package Contents
6. 进入 AppData → Documents → Matrix
7. 找到 .json 文件

### 日志文件长什么样？

日志是 JSON 格式，包含：
- 系统信息（设备型号、iOS 版本等）
- 线程堆栈
- 内存地址

示例：
```json
{
  "system": {
    "CFBundleName": "MatrixTestApp",
    "system_version": "16.0"
  },
  "crash": {
    "threads": [
      {
        "index": 0,
        "name": "main",
        "backtrace": {
          "contents": [...]
        }
      }
    ]
  }
}
```

## 🔍 第三步：符号化日志

### 自动符号化（推荐）

1. 在 Web 界面的「📤 上传」标签
2. 找到「2️⃣ 上传卡顿日志」区域
3. 拖拽或点击上传日志文件
4. **系统会自动符号化**（通过 UUID 匹配）
5. 符号化完成后会自动显示结果

### 手动符号化

如果自动符号化失败，可以手动操作：

1. 上传日志后，切换到「📋 报告列表」标签
2. 找到刚上传的报告
3. 点击「符号化」按钮
4. 等待处理完成

## 📊 第四步：查看结果

### 报告界面说明

符号化完成后，会显示一个详细的报告窗口：

```
================================
🎯 主线程: Thread 0
================================

👉  0  MatrixTestApp            0x102abc123
       -[TestLagViewController simulateLag] (TestLagViewController.mm:145)
    1  UIKit                    0x103def456
       -[UIApplication sendAction:to:from:forEvent:]
    2  libdispatch.dylib        0x104567890
       _dispatch_call_block_and_release
```

### 符号说明

- **👉** = 你的应用代码（重点关注！）
- **无标记** = 系统框架代码（UIKit、GCD 等）
- **文件名:行号** = 问题所在位置

### 如何解读？

1. **查找 👉 标记**：这些是你的代码
2. **看文件名和行号**：如 `TestLagViewController.mm:145`
3. **在 Xcode 中打开**：Cmd+Shift+O → 输入文件名
4. **跳转到对应行**：Cmd+L → 输入行号
5. **分析问题**：为什么这里会卡顿？

### 常见问题类型

**主线程阻塞：**
```
👉 -[ViewController heavyCalculation] (ViewController.mm:89)
   解决：移到后台线程
```

**同步网络请求：**
```
👉 -[NetworkManager syncRequest] (NetworkManager.mm:123)
   解决：使用异步请求
```

**磁盘 I/O：**
```
👉 -[DataManager saveToFile] (DataManager.mm:234)
   解决：使用后台队列
```

## 🎯 实战示例

### 完整流程演示

**场景：** 发现应用在点击某个按钮后卡顿

**第 1 步：重现问题**
```bash
# 1. 在 Xcode 中运行应用
# 2. 点击有问题的按钮
# 3. 等待卡顿发生
# 4. Matrix 会自动记录日志
```

**第 2 步：获取文件**
```bash
# 获取符号表
cd ~/Library/Developer/Xcode/DerivedData/MatrixTestApp-*/Build/Products/Debug-iphonesimulator/
zip -r ~/Desktop/symbols.dSYM.zip MatrixTestApp.app.dSYM

# 获取日志
xcrun simctl get_app_container booted com.tencent.MatrixTestApp data
cd {显示的路径}/Documents/Matrix/
cp {最新的json} ~/Desktop/lag.json
```

**第 3 步：上传和符号化**
```
1. 打开 http://localhost:8080
2. 上传 symbols.dSYM.zip
3. 上传 lag.json
4. 等待自动符号化
```

**第 4 步：分析结果**
```
发现问题：
👉 -[MyViewController processData] (MyViewController.mm:156)
   → 在主线程执行了耗时操作

修复方案：
dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    [self processData];
});
```

**第 5 步：验证修复**
```
1. 修改代码
2. 重新编译和运行
3. 再次触发操作
4. 确认不再卡顿
```

## 💡 使用技巧

### 技巧 1：保持符号表和日志版本一致

❌ 错误做法：
- 今天编译的应用
- 明天获取的符号表
- 用昨天的日志符号化

✅ 正确做法：
- 编译后立即获取 dSYM
- 立即触发测试并获取日志
- 立即符号化

### 技巧 2：建立命名规范

```bash
# 带版本号和日期的命名
MatrixTestApp_v1.0.0_20231222.dSYM.zip
lag_report_v1.0.0_20231222.json
```

### 技巧 3：批量处理

如果有多个日志：
1. 一次性上传所有符号表
2. 逐个上传日志（会自动匹配）
3. 在「📋 报告列表」中查看所有结果

### 技巧 4：定期清理

```bash
# 删除 30 天前的文件
cd matrix-symbolicate-server
find dsyms/ -mtime +30 -delete
find reports/ -mtime +30 -delete
```

### 技巧 5：导出报告

在报告详情窗口中：
1. Cmd+A 全选
2. Cmd+C 复制
3. 粘贴到文本编辑器
4. 保存为 .txt 文件

## ⚠️ 常见错误

### 错误 1：符号化后仍是地址

**原因：** dSYM 版本不匹配或缺少调试信息

**解决：**
```
1. 检查 Build Settings:
   - Debug Information Format = DWARF with dSYM
   - Strip Debug Symbols = NO (Debug)
2. Clean Build (Shift+Cmd+K)
3. 重新编译 (Cmd+B)
4. 重新获取 dSYM
```

### 错误 2：未找到匹配的符号表

**原因：** UUID 不匹配

**解决：**
```bash
# 查看 dSYM 的 UUID
dwarfdump --uuid MatrixTestApp.app/MatrixTestApp

# 查看报告的 UUID
# 打开 JSON 文件，搜索 "uuid"

# 确保两者一致
```

### 错误 3：没有应用代码

**原因：** 卡顿发生在系统代码中

**解决：**
- 这是正常情况
- 系统正在等待某个操作
- 检查是否有同步等待、锁等

## 📱 与 Matrix iOS 集成

### MatrixHandler 配置

确保 MatrixHandler.mm 中正确配置了卡顿监控：

```objective-c
// 启用卡顿监控
WCBlockMonitorConfig *blockConfig = [WCBlockMonitorConfig defaultConfig];
blockConfig.enableBlockMonitor = YES;
blockConfig.blockMonitorThreshold = 3; // 3秒阈值

WCCrashBlockMonitorPlugin *blockMonitor = [[WCCrashBlockMonitorPlugin alloc] init];
[blockMonitor setupPluginWithConfig:blockConfig];
[Matrix shareInstance] addPlugin:blockMonitor];
```

### 导出日志到服务器

可以在应用中添加自动上传功能：

```objective-c
// 示例：自动上传到符号化服务
- (void)uploadLagReport:(NSString *)reportPath {
    NSURL *url = [NSURL URLWithString:@"http://localhost:8080/api/report/upload"];
    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];
    request.HTTPMethod = @"POST";
    
    // 构建 multipart form data
    // ... 上传逻辑
}
```

## 🎓 学习资源

- **Matrix 文档**: https://github.com/Tencent/matrix
- **Apple 性能优化**: https://developer.apple.com/videos/play/wwdc2023/10181/
- **iOS 卡顿原因**: 主线程超过 1/60 秒未响应

## 🆘 需要帮助？

遇到问题时：

1. **查看日志**：服务器终端的输出
2. **查看文档**：TROUBLESHOOTING.md
3. **重新开始**：重启服务和浏览器
4. **提交 Issue**：包含完整错误信息

## ✨ 总结

**符号化服务的价值：**
- 🎯 快速定位卡顿问题
- 📊 清晰展示调用堆栈
- 🔍 区分应用代码和系统代码
- 💡 提供修复建议

**使用流程：**
```
编译应用 → 获取 dSYM → 触发卡顿 → 获取日志 → 上传符号化 → 查看结果 → 修复问题
```

**最佳实践：**
- ✅ Debug 模式编译
- ✅ 及时获取文件
- ✅ 版本保持一致
- ✅ 定期清理旧文件

---

**准备好了吗？** 打开 http://localhost:8080 开始你的第一次符号化！🚀

