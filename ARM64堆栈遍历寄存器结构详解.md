# ARM64 å †æ ˆéå† - å¯„å­˜å™¨è¯»å–è¿‡ç¨‹è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [ARM64 æ ¸å¿ƒå¯„å­˜å™¨ç»“æ„](#arm64-æ ¸å¿ƒå¯„å­˜å™¨ç»“æ„)
2. [æ ˆå¸§å†…å­˜å¸ƒå±€](#æ ˆå¸§å†…å­˜å¸ƒå±€)
3. [FrameEntry ç»“æ„ä¸å†…å­˜æ˜ å°„](#frameentry-ç»“æ„ä¸å†…å­˜æ˜ å°„)
4. [æ­¥éª¤ä¸‰ï¼šå¯„å­˜å™¨è¯»å–è¿‡ç¨‹](#æ­¥éª¤ä¸‰å¯„å­˜å™¨è¯»å–è¿‡ç¨‹)
5. [å®Œæ•´çš„å †æ ˆéå†æµç¨‹](#å®Œæ•´çš„å †æ ˆéå†æµç¨‹)

---

## ARM64 æ ¸å¿ƒå¯„å­˜å™¨ç»“æ„

### 1. é€šç”¨å¯„å­˜å™¨å¸ƒå±€ï¼ˆ64ä½ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARM64 å¯„å­˜å™¨ç»„ï¼ˆ64ä½ï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  x0  - x7    â”œâ”€ å‡½æ•°å‚æ•°ä¼ é€’ & è¿”å›å€¼                           â”‚
â”‚  x8         â”œâ”€ é—´æ¥è¿”å›å€¼åœ°å€                                    â”‚
â”‚  x9  - x15   â”œâ”€ ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰                         â”‚
â”‚  x16 - x17   â”œâ”€ å†…éƒ¨è°ƒç”¨ä¸´æ—¶å¯„å­˜å™¨ï¼ˆIP0, IP1ï¼‰                   â”‚
â”‚  x18        â”œâ”€ å¹³å°å¯„å­˜å™¨ï¼ˆä¿ç•™ï¼ŒæŸäº›å¹³å°ç”¨äºçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰       â”‚
â”‚  x19 - x28   â”œâ”€ è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨                               â”‚
â”‚                                                                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“  â”‚
â”‚  â”ƒ  ğŸ”´ x29 (FP) â”œâ”€ Frame Pointerï¼ˆå¸§æŒ‡é’ˆï¼‰                   â”ƒ  â”‚
â”‚  â”ƒ              â””â”€ æŒ‡å‘å½“å‰æ ˆå¸§çš„èµ·å§‹ä½ç½®                     â”ƒ  â”‚
â”‚  â”ƒ              â””â”€ ç”¨äºæ„å»ºè°ƒç”¨æ ˆé“¾è¡¨                         â”ƒ  â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›  â”‚
â”‚                                                                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“  â”‚
â”‚  â”ƒ  ğŸ”´ x30 (LR) â”œâ”€ Link Registerï¼ˆé“¾æ¥å¯„å­˜å™¨ï¼‰               â”ƒ  â”‚
â”‚  â”ƒ              â””â”€ ä¿å­˜å‡½æ•°è¿”å›åœ°å€                           â”ƒ  â”‚
â”‚  â”ƒ              â””â”€ bl æŒ‡ä»¤ä¼šè‡ªåŠ¨è®¾ç½® LR                       â”ƒ  â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›  â”‚
â”‚                                                                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“  â”‚
â”‚  â”ƒ  ğŸ”´ SP       â”œâ”€ Stack Pointerï¼ˆæ ˆæŒ‡é’ˆï¼‰                    â”ƒ  â”‚
â”‚  â”ƒ              â””â”€ æŒ‡å‘æ ˆé¡¶ï¼ˆå½“å‰å¯ç”¨çš„æ ˆç©ºé—´ï¼‰                â”ƒ  â”‚
â”‚  â”ƒ              â””â”€ 16 å­—èŠ‚å¯¹é½ï¼ˆAAPCS64 è¦æ±‚ï¼‰                â”ƒ  â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›  â”‚
â”‚                                                                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“  â”‚
â”‚  â”ƒ  ğŸ”´ PC       â”œâ”€ Program Counterï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰              â”ƒ  â”‚
â”‚  â”ƒ              â””â”€ æŒ‡å‘å½“å‰æ‰§è¡Œçš„æŒ‡ä»¤                          â”ƒ  â”‚
â”‚  â”ƒ              â””â”€ ä¸èƒ½ç›´æ¥å†™å…¥ï¼Œç”±è·³è½¬æŒ‡ä»¤ä¿®æ”¹                â”ƒ  â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›  â”‚
â”‚                                                                   â”‚
â”‚  xzr (x31)   â”œâ”€ é›¶å¯„å­˜å™¨ï¼ˆè¯»å–å§‹ç»ˆä¸º 0ï¼Œå†™å…¥è¢«å¿½ç•¥ï¼‰            â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å¯„å­˜å™¨åœ¨ KSMachineContext ä¸­çš„å­˜å‚¨

```c
typedef struct KSMachineContext {
    thread_t thisThread;
    bool isCurrentThread;
    bool isCrashedContext;
    bool isSignalContext;
    
    // ğŸ”´ æ ¸å¿ƒï¼šæœºå™¨ä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨å¿«ç…§ï¼‰
    _STRUCT_MCONTEXT machineContext;  
    
    // å…¶ä»–å­—æ®µ...
} KSMachineContext;

// ARM64 çš„ _STRUCT_MCONTEXT ç»“æ„ï¼š
typedef struct {
    _STRUCT_ARM_EXCEPTION_STATE64 __es;   // å¼‚å¸¸çŠ¶æ€
    _STRUCT_ARM_THREAD_STATE64    __ss;   // ğŸ”´ çº¿ç¨‹çŠ¶æ€ï¼ˆå¯„å­˜å™¨ï¼‰
    _STRUCT_ARM_NEON_STATE64      __ns;   // NEON/SIMD å¯„å­˜å™¨
} _STRUCT_MCONTEXT;

// ARM64 çº¿ç¨‹çŠ¶æ€ï¼ˆæˆ‘ä»¬å…³å¿ƒçš„éƒ¨åˆ†ï¼‰ï¼š
typedef struct {
    uint64_t __x[29];      // x0 - x28 é€šç”¨å¯„å­˜å™¨
    uint64_t __fp;         // ğŸ”´ x29 (Frame Pointer)
    uint64_t __lr;         // ğŸ”´ x30 (Link Register)
    uint64_t __sp;         // ğŸ”´ Stack Pointer
    uint64_t __pc;         // ğŸ”´ Program Counter
    uint32_t __cpsr;       // ç¨‹åºçŠ¶æ€å¯„å­˜å™¨
    uint32_t __pad;        // å¡«å……å¯¹é½
} _STRUCT_ARM_THREAD_STATE64;
```

---

## æ ˆå¸§å†…å­˜å¸ƒå±€

### 1. å•ä¸ªæ ˆå¸§çš„ç»“æ„ï¼ˆARM64ï¼‰

```
å‡½æ•°è°ƒç”¨æ—¶çš„æ±‡ç¼–æŒ‡ä»¤åºåˆ—ï¼š

funcB:
    sub   sp, sp, #32        ; 1ï¸âƒ£ åˆ†é…æ ˆç©ºé—´ï¼ˆ32 å­—èŠ‚ï¼‰
    stp   x29, x30, [sp, #16] ; 2ï¸âƒ£ ä¿å­˜ FP å’Œ LRï¼ˆå…³é”®ï¼ï¼‰
    add   x29, sp, #16       ; 3ï¸âƒ£ è®¾ç½®æ–°çš„ FP
    
    ; ... å‡½æ•°ä½“ ...
    
    ldp   x29, x30, [sp, #16] ; 4ï¸âƒ£ æ¢å¤ FP å’Œ LR
    add   sp, sp, #32        ; 5ï¸âƒ£ é‡Šæ”¾æ ˆç©ºé—´
    ret                       ; 6ï¸âƒ£ è¿”å›ï¼ˆè·³è½¬åˆ° LRï¼‰


å®é™…çš„æ ˆå¸§å†…å­˜å¸ƒå±€ï¼ˆä»é«˜åœ°å€åˆ°ä½åœ°å€ï¼‰ï¼š

    High Address (æ ˆåº•)
         â†‘
         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â† FP (x29) æŒ‡å‘è¿™é‡Œ
    â”‚                        â”‚
    â”‚  ğŸ”´ Previous FP        â”‚  FP + 0  (8 å­—èŠ‚)
    â”‚  (ä¸Šä¸€ä¸ªæ ˆå¸§çš„ x29)    â”‚  â””â”€ é“¾è¡¨æŒ‡é’ˆï¼ŒæŒ‡å‘è°ƒç”¨è€…çš„æ ˆå¸§
    â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â† FP + 8
    â”‚                        â”‚
    â”‚  ğŸ”´ Return Address     â”‚  FP + 8  (8 å­—èŠ‚)
    â”‚  (LR, x30 çš„å€¼)        â”‚  â””â”€ å‡½æ•°è¿”å›åè·³è½¬åˆ°è¿™é‡Œ
    â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â† FP + 16
    â”‚                        â”‚
    â”‚  Local Variables       â”‚  FP + 16 ~ FP + N
    â”‚  (å±€éƒ¨å˜é‡)            â”‚  â””â”€ å‡½æ•°çš„å±€éƒ¨å˜é‡å’Œä¸´æ—¶æ•°æ®
    â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â† SP (æ ˆæŒ‡é’ˆ) æŒ‡å‘è¿™é‡Œ
    â”‚                        â”‚
    â”‚  (æœªä½¿ç”¨çš„æ ˆç©ºé—´)      â”‚
    â”‚                        â”‚
         â”‚
         â†“
    Low Address (æ ˆé¡¶)


ğŸ”‘ å…³é”®ç‚¹ï¼š
1. FP å›ºå®šæŒ‡å‘ [Previous FP] çš„ä½ç½®
2. FP + 0  = Previous FPï¼ˆ8å­—èŠ‚ï¼‰
3. FP + 8  = Return Addressï¼ˆ8å­—èŠ‚ï¼‰
4. æ€»å…± 16 å­—èŠ‚ï¼Œåˆšå¥½æ˜¯ FrameEntry ç»“æ„çš„å¤§å°ï¼
```

### 2. å¤šå±‚æ ˆå¸§çš„é“¾å¼ç»“æ„

```
è°ƒç”¨é“¾ï¼šmain() â†’ funcA() â†’ funcB() â†’ funcC()

å†…å­˜å¸ƒå±€ï¼ˆä»é«˜åœ°å€åˆ°ä½åœ°å€ï¼‰ï¼š

    High Address (æ ˆåº•)
         â†‘
         â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘   main() çš„æ ˆå¸§        â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â† FPâ‚€ (main çš„ FP)
    â•‘  NULL                  â•‘  (æ²¡æœ‰ä¸Šä¸€ä¸ªæ ˆå¸§)
    â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£
    â•‘  0x100004000           â•‘  (main çš„è¿”å›åœ°å€ï¼Œé€šå¸¸æ˜¯ _start)
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘  å±€éƒ¨å˜é‡...           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         â”‚
         â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘   funcA() çš„æ ˆå¸§       â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â† FPâ‚ (funcA çš„ FP)
    â•‘  ğŸ”— FPâ‚€                â•‘  â† previous æŒ‡é’ˆ
    â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£      â”‚
    â•‘  0x100001234           â•‘  â† return address (åœ¨ main ä¸­)
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£      â”‚
    â•‘  å±€éƒ¨å˜é‡...           â•‘      â”‚
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚
         â”‚                          â”‚
         â–¼                          â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—      â”‚
    â•‘   funcB() çš„æ ˆå¸§       â•‘      â”‚
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â† FPâ‚‚ (funcB çš„ FP)
    â•‘  ğŸ”— FPâ‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚
    â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£      â”‚
    â•‘  0x100002456           â•‘  â† return address (åœ¨ funcA ä¸­)
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£      â”‚
    â•‘  å±€éƒ¨å˜é‡...           â•‘      â”‚
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚
         â”‚                          â”‚
         â–¼                          â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—      â”‚
    â•‘   funcC() çš„æ ˆå¸§       â•‘      â”‚
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â† FPâ‚ƒ (funcC çš„ FP, å½“å‰ x29 çš„å€¼)
    â•‘  ğŸ”— FPâ‚‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£
    â•‘  0x100003678           â•‘  â† return address (åœ¨ funcB ä¸­)
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘  å±€éƒ¨å˜é‡...           â•‘
    â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£ â† SP (å½“å‰æ ˆæŒ‡é’ˆ)
    â•‘  (æœªä½¿ç”¨)              â•‘
         â”‚
         â†“
    Low Address (æ ˆé¡¶)


ğŸ” é“¾è¡¨ç»“æ„å¯è§†åŒ–ï¼š

    FPâ‚ƒ (å½“å‰) â”€â”€â”
                 â”‚ previous
                 â–¼
    FPâ‚‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ previous
                 â–¼
    FPâ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ previous
                 â–¼
    FPâ‚€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ previous
                 â–¼
    NULL (æ ˆåº•)
```

---

## FrameEntry ç»“æ„ä¸å†…å­˜æ˜ å°„

### 1. FrameEntry ç»“æ„å®šä¹‰

```c
typedef struct FrameEntry {
    struct FrameEntry *previous;     // 8 å­—èŠ‚ - ä¸Šä¸€ä¸ªæ ˆå¸§çš„ FP
    uintptr_t return_address;        // 8 å­—èŠ‚ - è¿”å›åœ°å€ï¼ˆLRï¼‰
} FrameEntry;                        // æ€»å…± 16 å­—èŠ‚
```

### 2. FrameEntry ä¸å®é™…å†…å­˜çš„å®Œç¾æ˜ å°„

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ  ä¸ºä»€ä¹ˆ FrameEntry ç»“æ„å¯ä»¥ç›´æ¥æ˜ å°„åˆ°æ ˆå¸§å†…å­˜ï¼Ÿ              â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

ARM64 å‡½æ•°åºè¨€ï¼ˆPrologueï¼‰ä¿å­˜å¯„å­˜å™¨ï¼š
    stp x29, x30, [sp, #-16]!    ; å°† FP å’Œ LR å‹å…¥æ ˆ
    ; stp = Store Pair (å­˜å‚¨ä¸€å¯¹å¯„å­˜å™¨)
    ; x29 = FP, x30 = LR
    ; [sp, #-16]! = å…ˆ sp = sp - 16, å†å­˜å‚¨

å†…å­˜ä¸­çš„å®é™…å¸ƒå±€ï¼š
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    FP â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Previous FP (x29)    â”‚  â† 8 å­—èŠ‚
                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                 â”‚  Return Addr (x30)    â”‚  â† 8 å­—èŠ‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚  memcpy 16 å­—èŠ‚
                         â”‚
                         â–¼
    FrameEntry ç»“æ„ï¼š
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  previous             â”‚  â† 8 å­—èŠ‚
                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                 â”‚  return_address       â”‚  â† 8 å­—èŠ‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ ç»“è®ºï¼šå¯ä»¥ç›´æ¥ç”¨ memcpy å¤åˆ¶ 16 å­—èŠ‚ï¼
```

### 3. å­—æ®µå¯¹åº”å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å†…å­˜åœ°å€              â”‚  FrameEntry å­—æ®µ            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚                             â”‚
â”‚  FP + 0  (8 å­—èŠ‚)                 â”‚  previous                   â”‚
â”‚  â”œâ”€ ä¸Šä¸€ä¸ªæ ˆå¸§çš„ FP               â”‚  â”œâ”€ struct FrameEntry*     â”‚
â”‚  â””â”€ é“¾è¡¨æŒ‡é’ˆ                      â”‚  â””â”€ ç”¨äºç»§ç»­å‘ä¸Šéå†        â”‚
â”‚                                    â”‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚                             â”‚
â”‚  FP + 8  (8 å­—èŠ‚)                 â”‚  return_address             â”‚
â”‚  â”œâ”€ å‡½æ•°è¿”å›åœ°å€ï¼ˆLR çš„å€¼ï¼‰       â”‚  â”œâ”€ uintptr_t              â”‚
â”‚  â””â”€ è°ƒç”¨è€…ä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤          â”‚  â””â”€ ç”¨äºç¬¦å·åŒ–ï¼Œå®šä½è°ƒç”¨è€…  â”‚
â”‚                                    â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ­¥éª¤ä¸‰ï¼šå¯„å­˜å™¨è¯»å–è¿‡ç¨‹

### 1. è¯»å–æ“ä½œçš„è¯¦ç»†åˆ†è§£

```c
// advanceCursor å‡½æ•°ä¸­çš„æ­¥éª¤ä¸‰ï¼š
if (!ksmem_copySafely(context->currentFrame.previous, 
                      &context->currentFrame, 
                      sizeof(context->currentFrame))) {
    return false;
}
```

### 2. è¯»å–è¿‡ç¨‹å¯è§†åŒ–

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æ­¥éª¤ 3-1ï¼šå®šä½æºåœ°å€ï¼ˆä»å“ªé‡Œè¯»ï¼‰                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    context->currentFrame.previous â”€â”€â”€â”€â–º æºåœ°å€
                                          â”‚
                                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                å†…å­˜ï¼ˆæ ˆç©ºé—´ï¼‰                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  ...                                            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  0x000000016b5f8a20  â† previous FP             â”‚ â—„â”€â”
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
    â”‚  0x0000000102a3c4d8  â† return address          â”‚   â”‚ è¯»å–
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚ 16 å­—èŠ‚
    â”‚  ...                                            â”‚ â—„â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æ­¥éª¤ 3-2ï¼šæŒ‡å®šç›®æ ‡åœ°å€ï¼ˆå­˜å‚¨åˆ°å“ªé‡Œï¼‰                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    &context->currentFrame â”€â”€â”€â”€â–º ç›®æ ‡åœ°å€
                                 â”‚
                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      MachineContextCursor ç»“æ„                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  machineContext: 0x...                          â”‚
    â”‚  maxStackDepth: 100                             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  currentFrame: {                   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ å†™å…¥ä½ç½®
    â”‚    previous: [å¾…å†™å…¥]              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ 8 å­—èŠ‚
    â”‚    return_address: [å¾…å†™å…¥]        â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ 8 å­—èŠ‚
    â”‚  }                                              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  instructionAddress: 0x...                      â”‚
    â”‚  linkRegister: 0x...                            â”‚
    â”‚  isPastFramePointer: true                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æ­¥éª¤ 3-3ï¼šæ‰§è¡Œå®‰å…¨å¤åˆ¶ï¼ˆksmem_copySafelyï¼‰                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    æºåœ°å€ (æ ˆå†…å­˜)                        ç›®æ ‡åœ°å€ (currentFrame)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  0x16b5f8a20     â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º â”‚  previous        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   memcpy 16 å­—èŠ‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  0x102a3c4d8     â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º â”‚  return_address  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ksmem_copySafely çš„å®‰å…¨æœºåˆ¶ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  1. æ£€æŸ¥æºåœ°å€æ˜¯å¦æœ‰æ•ˆï¼ˆä¸æ˜¯é‡æŒ‡é’ˆï¼‰           â”‚
    â”‚  2. æ£€æŸ¥æºåœ°å€æ˜¯å¦å¯è¯»ï¼ˆvm_region æ£€æŸ¥ï¼‰       â”‚
    â”‚  3. ä½¿ç”¨ vm_read_overwrite è€Œä¸æ˜¯ç›´æ¥ memcpy  â”‚
    â”‚  4. å¦‚æœè¯»å–å¤±è´¥ï¼Œè¿”å› false è€Œä¸æ˜¯å´©æºƒ        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æ­¥éª¤ 3-4ï¼šè¯»å–ç»“æœéªŒè¯                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    è¯»å–æˆåŠŸåï¼ŒcurrentFrame çš„çŠ¶æ€ï¼š

    context->currentFrame = {
        previous:        0x000000016b5f8a20  âœ… æœ‰æ•ˆï¼ˆé NULLï¼‰
        return_address:  0x0000000102a3c4d8  âœ… æœ‰æ•ˆï¼ˆé 0ï¼‰
    }

    éªŒè¯é€»è¾‘ï¼ˆæ­¥éª¤ 4ï¼‰ï¼š
    if (context->currentFrame.previous == 0 || 
        context->currentFrame.return_address == 0) {
        return false;  // âŒ æ— æ•ˆæ•°æ®ï¼Œåœæ­¢éå†
    }

    âœ… éªŒè¯é€šè¿‡ï¼Œç»§ç»­éå†
```

### 3. å¯„å­˜å™¨æ•°æ®æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¯„å­˜å™¨æ•°æ®æµè½¬å…¨æ™¯å›¾                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ åˆå§‹çŠ¶æ€ï¼ˆä» KSMachineContext è¯»å–ï¼‰
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   KSMachineContext         â”‚
   â”‚  machineContext.__ss.__fp  â”‚ â”€â”€â”  ç¬¬ä¸€æ¬¡è¯»å–
   â”‚  machineContext.__ss.__lr  â”‚   â”‚  (æ­¥éª¤ 2)
   â”‚  machineContext.__ss.__pc  â”‚ â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚         â”‚
                                     â”‚         â”‚
                                     â–¼         â–¼
2ï¸âƒ£ å­˜å‚¨åˆ°æ¸¸æ ‡ä¸Šä¸‹æ–‡                PC å¯„å­˜å™¨  FP å¯„å­˜å™¨
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  (æ­¥éª¤ 1)   (æ­¥éª¤ 2)
   â”‚  MachineContextCursor      â”‚     â”‚         â”‚
   â”‚  â””â”€ instructionAddress     â”‚ â—„â”€â”€â”€â”˜         â”‚
   â”‚  â””â”€ currentFrame.previous  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚
                â–¼
3ï¸âƒ£ è¯»å–æ ˆå¸§æ•°æ®ï¼ˆæ­¥éª¤ 3 - æ ¸å¿ƒï¼ï¼‰
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ä» FP æŒ‡å‘çš„å†…å­˜è¯»å–ï¼š     â”‚
   â”‚                            â”‚
   â”‚  æºåœ°å€ï¼šFP (x29 çš„å€¼)      â”‚
   â”‚         â”‚                  â”‚
   â”‚         â–¼                  â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
   â”‚  â”‚  Previous FP     â”‚ â”€â”€â”€â”€â”€â”¼â”€â”€â–º currentFrame.previous
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
   â”‚  â”‚  Return Address  â”‚ â”€â”€â”€â”€â”€â”¼â”€â”€â–º currentFrame.return_address
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚
                â–¼
4ï¸âƒ£ æ›´æ–°æ¸¸æ ‡çŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  cursor->stackEntry        â”‚
   â”‚  â””â”€ address = return_address
   â”‚                            â”‚
   â”‚  cursor->state             â”‚
   â”‚  â””â”€ currentDepth++         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚
                â–¼
5ï¸âƒ£ ä¸‹ä¸€æ¬¡è¿­ä»£ï¼ˆFP é“¾è¡¨éå†ï¼‰
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  FP = currentFrame.previous â”‚ â† æ›´æ–° FP ä¸ºä¸Šä¸€ä¸ªæ ˆå¸§
   â”‚                            â”‚
   â”‚  é‡å¤æ­¥éª¤ 3-4              â”‚
   â”‚  ç›´åˆ° FP == NULL           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´çš„å †æ ˆéå†æµç¨‹

### 1. å®Œæ•´æµç¨‹å›¾ï¼ˆåŒ…å«æ‰€æœ‰æ­¥éª¤ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     advanceCursor å®Œæ•´æµç¨‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å¼€å§‹
     â”‚
     â”œâ”€â–º [å®‰å…¨æ£€æŸ¥] æ·±åº¦æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼Ÿ
     â”‚       â”‚                      â”‚
     â”‚       NO                    YES â†’ hasGivenUp = true
     â”‚       â”‚
     â”œâ”€â–º [æ­¥éª¤ 1] instructionAddress == 0?
     â”‚       â”‚                      â”‚
     â”‚       NO                    YES â”€â”€â”
     â”‚       â”‚                           â”‚
     â”‚       â”‚                           â–¼
     â”‚       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚              â”‚ è¯»å– PC å¯„å­˜å™¨             â”‚
     â”‚       â”‚              â”‚ instructionAddress =       â”‚
     â”‚       â”‚              â”‚   kscpu_instructionAddress â”‚
     â”‚       â”‚              â”‚   (ä» machineContext)      â”‚
     â”‚       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚                           â”‚
     â”‚       â”‚                           â””â”€â”€â–º è¿”å› PC (ç¬¬ä¸€å¸§) âœ…
     â”‚       â”‚
     â”œâ”€â–º [æ­¥éª¤ 2] currentFrame.previous == NULL?
     â”‚       â”‚                      â”‚
     â”‚       NO                    YES â”€â”€â”
     â”‚       â”‚                           â”‚
     â”‚       â”‚                           â–¼
     â”‚       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚              â”‚ è¯»å– FP å¯„å­˜å™¨             â”‚
     â”‚       â”‚              â”‚ currentFrame.previous =    â”‚
     â”‚       â”‚              â”‚   kscpu_framePointer       â”‚
     â”‚       â”‚              â”‚   (ä» machineContext)      â”‚
     â”‚       â”‚              â”‚ isPastFramePointer = true  â”‚
     â”‚       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”œâ”€â–º [æ­¥éª¤ 3] è¯»å–æ ˆå¸§ï¼ˆæ ¸å¿ƒï¼ï¼‰
     â”‚       â”‚
     â”‚       â–¼
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚ ksmem_copySafely(                           â”‚
     â”‚  â”‚   æº: currentFrame.previous,  â† FP åœ°å€     â”‚
     â”‚  â”‚   ç›®æ ‡: &currentFrame,        â† ç»“æ„ä½“åœ°å€  â”‚
     â”‚  â”‚   å¤§å°: 16 å­—èŠ‚               â† FrameEntry  â”‚
     â”‚  â”‚ )                                           â”‚
     â”‚  â”‚                                             â”‚
     â”‚  â”‚ å¤åˆ¶å†…å®¹ï¼š                                   â”‚
     â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
     â”‚  â”‚ â”‚ Previous FP     â”‚ â†’ currentFrame.previousâ”‚
     â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
     â”‚  â”‚ â”‚ Return Address  â”‚ â†’ currentFrame.return_address
     â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚              â”‚
     â”‚       æˆåŠŸ          å¤±è´¥ â†’ è¿”å› false âŒ
     â”‚       â”‚
     â”œâ”€â–º [æ­¥éª¤ 4] éªŒè¯æ•°æ®
     â”‚       â”‚
     â”‚       â–¼
     â”‚  previous == 0 æˆ– return_address == 0?
     â”‚       â”‚              â”‚
     â”‚       NO            YES â†’ è¿”å› false âŒ (åˆ°è¾¾æ ˆåº•)
     â”‚       â”‚
     â”œâ”€â–º [æ­¥éª¤ 5] æ›´æ–°æ¸¸æ ‡
     â”‚       â”‚
     â”‚       â–¼
     â”‚  cursor->stackEntry.address = return_address
     â”‚  cursor->state.currentDepth++
     â”‚       â”‚
     â”‚       â””â”€â”€â–º è¿”å› true âœ…
     â”‚
    ç»“æŸ
```

### 2. å¤šæ¬¡è°ƒç”¨çš„çŠ¶æ€æ¼”å˜

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ç¤ºä¾‹ï¼šéå† main â†’ funcA â†’ funcB â†’ funcC çš„è°ƒç”¨æ ˆ                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åˆå§‹çŠ¶æ€ï¼š
    machineContext å·²å¡«å……ï¼ˆthread_get_state è·å–ï¼‰
    â”œâ”€ __ss.__pc = 0x102a3c4d8  (funcC å½“å‰ä½ç½®)
    â”œâ”€ __ss.__fp = 0x16b5f8b80  (funcC çš„ FP)
    â””â”€ __ss.__lr = 0x102a3c890  (funcC çš„ LR)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ 1 æ¬¡è°ƒç”¨ advanceCursor()
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¿›å…¥æ¡ä»¶ï¼šinstructionAddress == 0 âœ…

æ“ä½œï¼š
    instructionAddress = kscpu_instructionAddress(machineContext)
                       = __ss.__pc
                       = 0x102a3c4d8

è¿”å›ï¼š
    cursor->stackEntry.address = 0x102a3c4d8
    cursor->state.currentDepth = 1

ç¬¦å·åŒ–åï¼š
    0x102a3c4d8 â†’ -[ViewController heavyTask] + 52


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ 2 æ¬¡è°ƒç”¨ advanceCursor()
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¿›å…¥æ¡ä»¶ï¼šcurrentFrame.previous == NULL âœ…

æ“ä½œï¼š
    currentFrame.previous = kscpu_framePointer(machineContext)
                          = __ss.__fp
                          = 0x16b5f8b80  (funcC çš„ FP)
    isPastFramePointer = true

ç»§ç»­æ‰§è¡Œæ­¥éª¤ 3ï¼š
    ksmem_copySafely(0x16b5f8b80, &currentFrame, 16)
    
    ä»å†…å­˜è¯»å–ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  0x16b5f8b00     â”‚ â†’ currentFrame.previous  (funcB çš„ FP)
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  0x102a3c890     â”‚ â†’ currentFrame.return_address
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿”å›ï¼š
    cursor->stackEntry.address = 0x102a3c890
    cursor->state.currentDepth = 2

ç¬¦å·åŒ–åï¼š
    0x102a3c890 â†’ -[ViewController processData] + 124


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ 3 æ¬¡è°ƒç”¨ advanceCursor()
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¿›å…¥æ¡ä»¶ï¼šcurrentFrame.previous == 0x16b5f8b00 (æœ‰æ•ˆ) âœ…

æ“ä½œï¼š
    ksmem_copySafely(0x16b5f8b00, &currentFrame, 16)
    
    ä»å†…å­˜è¯»å–ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  0x16b5f8a80     â”‚ â†’ currentFrame.previous  (funcA çš„ FP)
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  0x102a3c456     â”‚ â†’ currentFrame.return_address
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿”å›ï¼š
    cursor->stackEntry.address = 0x102a3c456
    cursor->state.currentDepth = 3

ç¬¦å·åŒ–åï¼š
    0x102a3c456 â†’ -[ViewController viewDidLoad] + 78


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ 4 æ¬¡è°ƒç”¨ advanceCursor()
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¿›å…¥æ¡ä»¶ï¼šcurrentFrame.previous == 0x16b5f8a80 (æœ‰æ•ˆ) âœ…

æ“ä½œï¼š
    ksmem_copySafely(0x16b5f8a80, &currentFrame, 16)
    
    ä»å†…å­˜è¯»å–ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  0x16b5f8a00     â”‚ â†’ currentFrame.previous  (main çš„ FP)
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  0x1a8b2c3f0     â”‚ â†’ currentFrame.return_address
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿”å›ï¼š
    cursor->stackEntry.address = 0x1a8b2c3f0
    cursor->state.currentDepth = 4

ç¬¦å·åŒ–åï¼š
    0x1a8b2c3f0 â†’ -[UIViewController loadViewIfRequired] (UIKitCore)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ 5 æ¬¡è°ƒç”¨ advanceCursor()
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¿›å…¥æ¡ä»¶ï¼šcurrentFrame.previous == 0x16b5f8a00 (æœ‰æ•ˆ) âœ…

æ“ä½œï¼š
    ksmem_copySafely(0x16b5f8a00, &currentFrame, 16)
    
    ä»å†…å­˜è¯»å–ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  0x00000000      â”‚ â†’ currentFrame.previous  (NULL, æ ˆåº•ï¼)
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  0x100004000     â”‚ â†’ currentFrame.return_address
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

éªŒè¯å¤±è´¥ï¼š
    currentFrame.previous == 0 âŒ

è¿”å›ï¼š
    false (éå†ç»“æŸ)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æœ€ç»ˆç»“æœï¼šå®Œæ•´çš„è°ƒç”¨æ ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

0: 0x102a3c4d8  MyApp  -[ViewController heavyTask] + 52
1: 0x102a3c890  MyApp  -[ViewController processData] + 124
2: 0x102a3c456  MyApp  -[ViewController viewDidLoad] + 78
3: 0x1a8b2c3f0  UIKitCore  -[UIViewController loadViewIfRequired]
4: ...
```

---

## ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“

### 1. ä¸ºä»€ä¹ˆ FrameEntry ç»“æ„å¯ä»¥ç›´æ¥æ˜ å°„å†…å­˜ï¼Ÿ

```
ARM64 ABI è§„å®šï¼š
- å‡½æ•°åºè¨€å¿…é¡»ä¿å­˜ FP (x29) å’Œ LR (x30)
- ä½¿ç”¨ stp æŒ‡ä»¤ï¼šstp x29, x30, [sp, #-16]!
- å†…å­˜å¸ƒå±€ï¼š[FP (8å­—èŠ‚), LR (8å­—èŠ‚)]
- FrameEntry ç»“æ„ï¼š{previous (8å­—èŠ‚), return_address (8å­—èŠ‚)}
- å®Œç¾åŒ¹é…ï¼å¯ä»¥ç›´æ¥ memcpy
```

### 2. ä¸ºä»€ä¹ˆéœ€è¦ ksmem_copySafelyï¼Ÿ

```
å®‰å…¨è€ƒè™‘ï¼š
1. FP å¯èƒ½æŒ‡å‘æ— æ•ˆå†…å­˜ï¼ˆå †æ ˆæŸåï¼‰
2. FP å¯èƒ½æŒ‡å‘å—ä¿æŠ¤çš„å†…å­˜é¡µ
3. FP å¯èƒ½æ˜¯é‡æŒ‡é’ˆï¼ˆç¼–è¯‘å™¨ä¼˜åŒ–å¯¼è‡´ï¼‰
4. ç›´æ¥è®¿é—®å¯èƒ½å¯¼è‡´ SIGSEGV å´©æºƒ

ksmem_copySafely çš„ä¿æŠ¤æœºåˆ¶ï¼š
- ä½¿ç”¨ vm_region æ£€æŸ¥åœ°å€æœ‰æ•ˆæ€§
- ä½¿ç”¨ vm_read_overwrite è€Œä¸æ˜¯ç›´æ¥ memcpy
- å¤±è´¥æ—¶è¿”å› falseï¼Œè€Œä¸æ˜¯å´©æºƒ
```

### 3. éå†æµç¨‹çš„ä¸‰ä¸ªé˜¶æ®µ

```
é˜¶æ®µ 1ï¼šè·å– PC (ç¬¬ 1 æ¬¡è°ƒç”¨)
    â””â”€ ä» machineContext è¯»å–å½“å‰æŒ‡ä»¤åœ°å€

é˜¶æ®µ 2ï¼šè·å–åˆå§‹ FP (ç¬¬ 2 æ¬¡è°ƒç”¨)
    â””â”€ ä» machineContext è¯»å–å¸§æŒ‡é’ˆ

é˜¶æ®µ 3ï¼šFP é“¾è¡¨éå† (ç¬¬ 3-N æ¬¡è°ƒç”¨)
    â””â”€ é€šè¿‡ previous æŒ‡é’ˆé€å¸§å›æº¯
```

---

## ğŸ“Š æ€§èƒ½åˆ†æ

```
å•æ¬¡ advanceCursor çš„å¼€é”€ï¼š

1. å†…å­˜è®¿é—®ï¼š
   - è¯»å– FP æŒ‡å‘çš„ 16 å­—èŠ‚ï¼š~5-10ns
   - L1 ç¼“å­˜å‘½ä¸­ï¼š~1-4 ä¸ªæ—¶é’Ÿå‘¨æœŸ

2. ksmem_copySafely é¢å¤–å¼€é”€ï¼š
   - vm_region æ£€æŸ¥ï¼š~100-200ns
   - å†…å­˜ä¿æŠ¤æ£€æŸ¥ï¼š~50-100ns

3. æ€»å¼€é”€ï¼š
   - ç¼“å­˜å‘½ä¸­ï¼š~200-500ns
   - ç¼“å­˜æœªå‘½ä¸­ï¼š~1-2Î¼s

4. 100 å±‚å †æ ˆçš„æ€»è€—æ—¶ï¼š
   - ç†æƒ³æƒ…å†µï¼š~50Î¼s
   - ä¸€èˆ¬æƒ…å†µï¼š~100-200Î¼s
   - è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¡é¡¿æ£€æµ‹æ€§èƒ½å¼€é”€å¾ˆå°ï¼
```

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æ‰“å°å¯„å­˜å™¨çŠ¶æ€

```c
void debugPrintRegisters(const KSMachineContext* ctx) {
    printf("PC:  0x%016llx\n", ctx->machineContext.__ss.__pc);
    printf("FP:  0x%016llx\n", ctx->machineContext.__ss.__fp);
    printf("LR:  0x%016llx\n", ctx->machineContext.__ss.__lr);
    printf("SP:  0x%016llx\n", ctx->machineContext.__ss.__sp);
}
```

### 2. éªŒè¯æ ˆå¸§æœ‰æ•ˆæ€§

```c
bool isValidStackFrame(uintptr_t fp) {
    // æ£€æŸ¥å¯¹é½ï¼ˆARM64 16 å­—èŠ‚å¯¹é½ï¼‰
    if (fp & 0xF) return false;
    
    // æ£€æŸ¥åœ°å€èŒƒå›´ï¼ˆæ ˆé€šå¸¸åœ¨é«˜åœ°å€ï¼‰
    if (fp < 0x16b000000) return false;
    if (fp > 0x170000000) return false;
    
    return true;
}
```

### 3. å¯è§†åŒ–å †æ ˆéå†

```c
void visualizeStackWalk(KSStackCursor* cursor) {
    int depth = 0;
    while (cursor->advanceCursor(cursor)) {
        printf("[%d] 0x%016llx", depth++, cursor->stackEntry.address);
        if (cursor->symbolicate(cursor)) {
            printf("  %s (%s)\n", 
                   cursor->stackEntry.symbolName,
                   cursor->stackEntry.imageName);
        } else {
            printf("  ???\n");
        }
    }
}
```

---

**ğŸ“Œ è¿™å°±æ˜¯ ARM64 å †æ ˆéå†çš„å®Œæ•´å¯„å­˜å™¨è¯»å–è¿‡ç¨‹ï¼**
