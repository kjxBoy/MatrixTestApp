/*
 * Tencent is pleased to support the open source community by making wechat-matrix available.
 * Copyright (C) 2019 THL A29 Limited, a Tencent company. All rights reserved.
 * Licensed under the BSD 3-Clause License (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://opensource.org/licenses/BSD-3-Clause
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * memory_logging.h - Matrix å†…å­˜ç›‘æ§æ ¸å¿ƒæ¥å£ï¼ˆC++ å±‚ï¼‰
 * 
 * ============================================================================
 * åŠŸèƒ½æ¦‚è¿°
 * ============================================================================
 * 
 * è¿™æ˜¯ Matrix å†…å­˜ç›‘æ§çš„æ ¸å¿ƒ C++ å±‚å®ç°ï¼Œæä¾›ï¼š
 * 
 * 1. malloc/free æ‹¦æˆª
 *    - é€šè¿‡ malloc_logger æ‹¦æˆªæ‰€æœ‰å †å†…å­˜åˆ†é…
 *    - è®°å½•åˆ†é…åœ°å€ã€å¤§å°ã€å †æ ˆã€æ—¶é—´æˆ³
 * 
 * 2. å¼‚æ­¥æŒä¹…åŒ–
 *    - å°†å†…å­˜äº‹ä»¶å†™å…¥ç¯å½¢ç¼“å†²åŒºï¼ˆæ— é”ï¼Œå¾®ç§’çº§ï¼‰
 *    - åå°çº¿ç¨‹å¼‚æ­¥å†™å…¥ç£ç›˜ï¼ˆ5-10ms å»¶è¿Ÿï¼‰
 * 
 * 3. å®æ—¶å†…å­˜å¿«ç…§
 *    - æ”¯æŒéšæ—¶å¯¼å‡ºå½“å‰å†…å­˜åˆ†å¸ƒ
 *    - ç”Ÿæˆ JSON æ ¼å¼çš„åˆ†ææŠ¥å‘Š
 * 
 * ============================================================================
 * æ ¸å¿ƒå·¥ä½œåŸç†
 * ============================================================================
 * 
 * å¯åŠ¨æµç¨‹ (enable_memory_logging)ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ 1. åˆå§‹åŒ–å†…éƒ¨åˆ†é…å™¨ (inter_zone)                             â”‚
 * â”‚ 2. æ£€æµ‹åˆ†æå·¥å…· (Instrumentsã€MallocStackLogging)            â”‚
 * â”‚ 3. åˆ›å»ºæ•°æ®åº“æ–‡ä»¶ï¼š                                          â”‚
 * â”‚    - allocation_event_db.dat (åˆ†é…äº‹ä»¶)                      â”‚
 * â”‚    - stack_frames_db.dat (å †æ ˆä¿¡æ¯)                          â”‚
 * â”‚    - dyld_image_info.dat (dyld é•œåƒä¿¡æ¯)                     â”‚
 * â”‚    - object_type.dat (å¯¹è±¡ç±»å‹)                              â”‚
 * â”‚ 4. åˆ›å»ºç¯å½¢ç¼“å†²åŒºæ±  (buffer_pool)                            â”‚
 * â”‚ 5. å¯åŠ¨å¼‚æ­¥å†™å…¥çº¿ç¨‹ (__memory_event_writing_thread)          â”‚
 * â”‚ 6. è®¾ç½® malloc_logger = __memory_event_callback             â”‚
 * â”‚ 7. (å¯é€‰) è®¾ç½® __syscall_logger (ç§æœ‰APIï¼Œç›‘æ§VMåˆ†é…)        â”‚
 * â”‚ 8. æ ‡è®° s_logging_is_enable = true                          â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * è¿è¡Œæ—¶æ‹¦æˆªæµç¨‹ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ App è°ƒç”¨: ptr = malloc(100)                                  â”‚
 * â”‚     â†“                                                        â”‚
 * â”‚ malloc_logger å›è°ƒ: __memory_event_callback()                â”‚
 * â”‚     â†“                                                        â”‚
 * â”‚ 1. æ£€æŸ¥æ˜¯å¦å¯ç”¨ (s_logging_is_enable)                        â”‚
 * â”‚ 2. æ£€æŸ¥çº¿ç¨‹æ ‡å¿— (is_ignore) - é¿å…é€’å½’                       â”‚
 * â”‚ 3. è·å–å½“å‰çº¿ç¨‹çš„äº‹ä»¶ç¼“å†²åŒº                                   â”‚
 * â”‚ 4. è®°å½•åˆ†é…äº‹ä»¶ï¼š                                             â”‚
 * â”‚    - address: åˆ†é…çš„åœ°å€                                     â”‚
 * â”‚    - size: åˆ†é…çš„å¤§å°                                        â”‚
 * â”‚    - stacks: è°ƒç”¨å †æ ˆ (é€šè¿‡ backtrace è·å–)                  â”‚
 * â”‚    - stack_hash: å †æ ˆçš„å“ˆå¸Œå€¼ (å»é‡ç”¨)                       â”‚
 * â”‚ 5. å†™å…¥ç¯å½¢ç¼“å†²åŒº (æ— é”æ“ä½œï¼Œ<1å¾®ç§’)                          â”‚
 * â”‚     â†“                                                        â”‚
 * â”‚ åå°å†™å…¥çº¿ç¨‹: __memory_event_writing_thread()                â”‚
 * â”‚     â†“                                                        â”‚
 * â”‚ 1. ä»ç¼“å†²åŒºæ± å–å‡ºå¾…å†™å…¥çš„ç¼“å†²åŒº                               â”‚
 * â”‚ 2. éå†æ‰€æœ‰äº‹ä»¶                                              â”‚
 * â”‚ 3. å»é‡å¹¶å†™å…¥å †æ ˆåˆ° stack_frames_db.dat                      â”‚
 * â”‚ 4. å†™å…¥åˆ†é…äº‹ä»¶åˆ° allocation_event_db.dat                    â”‚
 * â”‚ 5. æ›´æ–°åˆ†é…è¡¨ (åœ°å€ â†’ å †æ ˆID çš„æ˜ å°„)                          â”‚
 * â”‚ 6. å›æ”¶ç¼“å†²åŒºåˆ°æ± ä¸­                                          â”‚
 * â”‚ 7. sleep(5-10ms) é¿å…è¿‡åº¦æ¶ˆè€— CPU                            â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * åœæ­¢æµç¨‹ (disable_memory_logging)ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ 1. malloc_logger = NULL (åœæ­¢æ‹¦æˆª)                           â”‚
 * â”‚ 2. s_logging_is_enable = false (é€šçŸ¥å†™å…¥çº¿ç¨‹)                â”‚
 * â”‚ 3. ç­‰å¾…å†™å…¥çº¿ç¨‹å¤„ç†å®Œæ‰€æœ‰ç¼“å†²åŒº                               â”‚
 * â”‚ 4. å…³é—­æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶                                        â”‚
 * â”‚ 5. é‡Šæ”¾ç¼“å†²åŒºæ±                                               â”‚
 * â”‚ 6. æ¸…ç†èµ„æº                                                  â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * ============================================================================
 * æ•°æ®ç»“æ„
 * ============================================================================
 * 
 * memory_logging_event (å†…å­˜äº‹ä»¶)ï¼š
 * - address: åˆ†é…çš„åœ°å€
 * - size: åˆ†é…çš„å¤§å°
 * - type_flags: ç±»å‹æ ‡å¿— (malloc/vm_allocate/free/vm_deallocate)
 * - event_type: äº‹ä»¶ç±»å‹ (Alloc/Free/Update)
 * - stack_size: å †æ ˆæ·±åº¦
 * - stack_hash: å †æ ˆå“ˆå¸Œå€¼
 * - stacks[]: å †æ ˆå¸§æ•°ç»„
 * 
 * memory_logging_event_buffer (äº‹ä»¶ç¼“å†²åŒº)ï¼š
 * - æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªç¼“å†²åŒº (thread-local)
 * - ç¯å½¢ç¼“å†²åŒºï¼Œæ»¡äº†å°±åˆ†é…æ–°çš„
 * - å¤§å°çº¦ 64KB
 * 
 * ============================================================================
 * æ€§èƒ½ä¼˜åŒ–
 * ============================================================================
 * 
 * 1. æ— é”ç¯å½¢ç¼“å†²åŒºï¼š
 *    - ä¸»çº¿ç¨‹å†™å…¥ç¼“å†²åŒºæ— éœ€åŠ é”
 *    - åå°çº¿ç¨‹å¼‚æ­¥è¯»å–
 *    - é¿å…é˜»å¡ä¸»çº¿ç¨‹
 * 
 * 2. å †æ ˆå»é‡ï¼š
 *    - ä½¿ç”¨ stack_hash å¿«é€Ÿåˆ¤é‡
 *    - ç›¸åŒå †æ ˆåªå­˜å‚¨ä¸€æ¬¡
 *    - å¤§å¹…å‡å°‘ç£ç›˜ç©ºé—´
 * 
 * 3. äº‹ä»¶å‹ç¼©ï¼š
 *    - malloc + free å¯ä»¥åˆå¹¶æŠµæ¶ˆ
 *    - å‡å°‘å†™å…¥æ•°æ®é‡
 * 
 * 4. å†…éƒ¨åˆ†é…éš”ç¦»ï¼š
 *    - inter_zone ä¸“ç”¨åˆ†é…å™¨
 *    - é€šè¿‡ is_ignore æ ‡å¿—é¿å…é€’å½’ç›‘æ§
 * 
 * 5. è¿‡æ»¤ç­–ç•¥ï¼š
 *    - skip_min_malloc_size: è·³è¿‡å°åˆ†é…
 *    - skip_max_stack_depth: è·³è¿‡æµ…å †æ ˆ
 * 
 * ============================================================================
 */

#import <malloc/malloc.h>
#import <mach/vm_statistics.h>

#include "memory_report_generator.h"
#include "memory_stat_err_code.h"

/**
 * å…¨å±€é…ç½®ï¼šæ˜¯å¦å¯¼å‡ºè°ƒç”¨å †æ ˆ
 * 
 * å–å€¼ï¼š
 * - 0: ä¸å¯¼å‡ºå †æ ˆï¼ˆåªè®°å½•åˆ†é…å¤§å°ï¼‰
 * - 1: å¯¼å‡ºæ‰€æœ‰å¯¹è±¡çš„å †æ ˆï¼ˆæ¨èï¼‰
 * - 2: ä»…å¯¼å‡º ObjC å¯¹è±¡çš„å †æ ˆ
 * 
 * è¯´æ˜ï¼š
 * - åœ¨ WCMemoryStatPlugin.start ä¸­è®¾ç½®
 * - å¯¼å‡ºå †æ ˆä¼šå¢åŠ æ€§èƒ½å¼€é”€ï¼ˆçº¦ 10-50 å¾®ç§’/æ¬¡åˆ†é…ï¼‰
 * - ä¸å¯¼å‡ºå †æ ˆåˆ™æ— æ³•åˆ†æå†…å­˜æ¥æº
 */
extern int dump_call_stacks;

/**
 * å¯åŠ¨å†…å­˜ç›‘æ§
 * 
 * @param root_dir æ ¹ç›®å½•ï¼Œç”¨äºå­˜å‚¨å…±äº«æ•°æ®ï¼ˆå¦‚å †æ ˆç¼“å­˜è¡¨ï¼‰
 * @param log_dir æ—¥å¿—ç›®å½•ï¼Œç”¨äºå­˜å‚¨æœ¬æ¬¡è¿è¡Œçš„æ•°æ®æ–‡ä»¶
 * @return é”™è¯¯ç ï¼ŒMS_ERRC_SUCCESS(0) è¡¨ç¤ºæˆåŠŸ
 * 
 * åŠŸèƒ½ï¼š
 * 1. åˆå§‹åŒ–å†…éƒ¨åˆ†é…å™¨ (inter_zone)
 * 2. æ£€æµ‹æ˜¯å¦æœ‰åˆ†æå·¥å…·è¿è¡Œ (Instruments)
 * 3. åˆ›å»ºæ•°æ®åº“æ–‡ä»¶ï¼š
 *    - allocation_event_db.dat: åˆ†é…äº‹ä»¶
 *    - stack_frames_db.dat: å †æ ˆä¿¡æ¯
 *    - dyld_image_info.dat: dyld é•œåƒ
 *    - object_type.dat: å¯¹è±¡ç±»å‹
 * 4. åˆ›å»ºç¯å½¢ç¼“å†²åŒºæ± 
 * 5. å¯åŠ¨å¼‚æ­¥å†™å…¥çº¿ç¨‹
 * 6. è®¾ç½® malloc_logger å›è°ƒ
 * 7. (å¯é€‰) è®¾ç½® __syscall_logger å›è°ƒ
 * 
 * é”™è¯¯ç ï¼š
 * - MS_ERRC_SUCCESS (0): æˆåŠŸ
 * - MS_ERRC_WORKING_THREAD_CREATE_FAIL: åˆ›å»ºå·¥ä½œçº¿ç¨‹å¤±è´¥
 * - MS_ERRC_ANALYSIS_TOOL_RUNNING: æ£€æµ‹åˆ°åˆ†æå·¥å…·ï¼ˆå¦‚ Instrumentsï¼‰
 * - MS_ERRC_SF_TABLE_FILE_OPEN_FAIL: æ‰“å¼€å †æ ˆè¡¨æ–‡ä»¶å¤±è´¥
 * - å…¶ä»–é”™è¯¯ç è§ memory_stat_err_code.h
 * 
 * å·¥ä½œæµç¨‹ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ 1. logger_internal_init()               â”‚ â†’ åˆå§‹åŒ– inter_zone
 * â”‚ 2. is_analysis_tool_running()           â”‚ â†’ æ£€æµ‹ Instruments
 * â”‚ 3. shared_memory_pool_file_init()       â”‚ â†’ åˆå§‹åŒ–å…±äº«å†…å­˜æ± 
 * â”‚ 4. allocation_event_db_open_or_create() â”‚ â†’ åˆ›å»ºåˆ†é…äº‹ä»¶æ•°æ®åº“
 * â”‚ 5. stack_frames_db_open_or_create()     â”‚ â†’ åˆ›å»ºå †æ ˆæ•°æ®åº“
 * â”‚ 6. prepare_dyld_image_logger()          â”‚ â†’ å‡†å¤‡ dyld æ—¥å¿—
 * â”‚ 7. prepare_object_event_logger()        â”‚ â†’ å‡†å¤‡å¯¹è±¡äº‹ä»¶æ—¥å¿—
 * â”‚ 8. memory_logging_event_buffer_pool_create() â”‚ â†’ åˆ›å»ºç¼“å†²åŒºæ± 
 * â”‚ 9. __prepare_working_thread()           â”‚ â†’ å¯åŠ¨å†™å…¥çº¿ç¨‹
 * â”‚ 10. malloc_logger = __memory_event_callback â”‚ â†’ è®¾ç½®æ‹¦æˆª
 * â”‚ 11. s_logging_is_enable = true          â”‚ â†’ å¯ç”¨ç›‘æ§
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * æ³¨æ„äº‹é¡¹ï¼š
 * - å¿…é¡»åœ¨ä¸»çº¿ç¨‹è°ƒç”¨
 * - è°ƒç”¨å‰åº”è¯¥æ£€æŸ¥ isBeingDebuggedï¼ˆè°ƒè¯•æ—¶æ€§èƒ½å½±å“å¤§ï¼‰
 * - å¯åŠ¨å¤±è´¥ä¼šè‡ªåŠ¨æ¸…ç†èµ„æº
 * - ä¸èƒ½é‡å¤è°ƒç”¨ï¼ˆéœ€è¦å…ˆè°ƒç”¨ disable_memory_loggingï¼‰
 * 
 * ä½¿ç”¨ç¤ºä¾‹ï¼š
 * ```objc
 * NSString *rootPath = @"/path/to/root";
 * NSString *logPath = @"/path/to/logs/1234567890";
 * 
 * int ret = enable_memory_logging(rootPath.UTF8String, logPath.UTF8String);
 * if (ret == MS_ERRC_SUCCESS) {
 *     NSLog(@"âœ… å†…å­˜ç›‘æ§å·²å¯åŠ¨");
 * } else {
 *     NSLog(@"âŒ å¯åŠ¨å¤±è´¥: %d", ret);
 * }
 * ```
 */
int enable_memory_logging(const char *root_dir, const char *log_dir);

/**
 * åœæ­¢å†…å­˜ç›‘æ§
 * 
 * åŠŸèƒ½ï¼š
 * 1. åœæ­¢æ‹¦æˆª malloc/free (malloc_logger = NULL)
 * 2. é€šçŸ¥å†™å…¥çº¿ç¨‹åœæ­¢ (s_logging_is_enable = false)
 * 3. ç­‰å¾…å†™å…¥çº¿ç¨‹å¤„ç†å®Œæ‰€æœ‰ç¼“å†²åŒº
 * 4. å…³é—­æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶ï¼ˆè‡ªåŠ¨åˆ·æ–°ç¼“å†²åŒºï¼‰
 * 5. é‡Šæ”¾ç¼“å†²åŒºæ± 
 * 6. æ¸…ç†èµ„æº
 * 
 * å·¥ä½œæµç¨‹ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ 1. s_logging_is_enable = false          â”‚ â†’ æ ‡è®°åœæ­¢
 * â”‚ 2. disable_object_event_logger()        â”‚ â†’ åœæ­¢å¯¹è±¡äº‹ä»¶è®°å½•
 * â”‚ 3. malloc_logger = NULL                 â”‚ â†’ åœæ­¢æ‹¦æˆª malloc
 * â”‚ 4. *syscall_logger = NULL (å¯é€‰)        â”‚ â†’ åœæ­¢æ‹¦æˆª VM åˆ†é…
 * â”‚ 5. ç­‰å¾…å†™å…¥çº¿ç¨‹é€€å‡º                     â”‚ â†’ å¤„ç†å®Œæ‰€æœ‰äº‹ä»¶
 * â”‚ 6. stack_frames_db_close()              â”‚ â†’ å…³é—­å †æ ˆæ•°æ®åº“
 * â”‚ 7. allocation_event_db_close()          â”‚ â†’ å…³é—­åˆ†é…äº‹ä»¶æ•°æ®åº“
 * â”‚ 8. dyld_image_info_db_close()           â”‚ â†’ å…³é—­ dyld æ•°æ®åº“
 * â”‚ 9. object_type_db_close()               â”‚ â†’ å…³é—­å¯¹è±¡ç±»å‹æ•°æ®åº“
 * â”‚ 10. memory_logging_event_buffer_pool_free() â”‚ â†’ é‡Šæ”¾ç¼“å†²åŒºæ± 
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * æ³¨æ„äº‹é¡¹ï¼š
 * - å¯ä»¥å®‰å…¨åœ°å¤šæ¬¡è°ƒç”¨ï¼ˆå†…éƒ¨æœ‰æ£€æŸ¥ï¼‰
 * - ä¼šç­‰å¾…å†™å…¥çº¿ç¨‹å®Œæˆï¼Œå¯èƒ½éœ€è¦å‡ ç™¾æ¯«ç§’
 * - åœæ­¢åæ‰€æœ‰æ•°æ®å·²åˆ·æ–°åˆ°ç£ç›˜
 * - å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œä¹Ÿä¼šè‡ªåŠ¨è°ƒç”¨æ­¤å‡½æ•°æ¸…ç†
 * 
 * ä½¿ç”¨ç¤ºä¾‹ï¼š
 * ```objc
 * // æ­£å¸¸åœæ­¢
 * disable_memory_logging();
 * NSLog(@"âœ… å†…å­˜ç›‘æ§å·²åœæ­¢");
 * 
 * // æˆ–è€…åœ¨é”™è¯¯æ—¶è‡ªåŠ¨è°ƒç”¨
 * if (error_occurred) {
 *     disable_memory_logging();  // è‡ªåŠ¨æ¸…ç†
 * }
 * ```
 */
void disable_memory_logging(void);

/**
 * è§¦å‘å†…å­˜å¿«ç…§å¹¶å¯¼å‡ºæŠ¥å‘Š
 * 
 * @param callback å›è°ƒå‡½æ•°ï¼Œæ¥æ”¶ç”Ÿæˆçš„ JSON æŠ¥å‘Šæ•°æ®
 * @param param æŠ¥å‘Šå‚æ•°ï¼ˆè®¾å¤‡ä¿¡æ¯ã€æ—¶é—´æˆ³ã€è‡ªå®šä¹‰ä¿¡æ¯ç­‰ï¼‰
 * @return true æˆåŠŸè§¦å‘ï¼Œfalse å¤±è´¥
 * 
 * åŠŸèƒ½ï¼š
 * - ä¸åœæ­¢ç›‘æ§ï¼Œç«‹å³ç”Ÿæˆå½“å‰å†…å­˜åˆ†å¸ƒçš„å¿«ç…§
 * - åœ¨åå°çº¿ç¨‹ç”Ÿæˆ JSON æ ¼å¼çš„æŠ¥å‘Š
 * - é€šè¿‡ callback è¿”å›æŠ¥å‘Šæ•°æ®
 * 
 * å·¥ä½œæµç¨‹ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ ä¸»çº¿ç¨‹: memory_dump(callback, param)                        â”‚
 * â”‚     â†“                                                       â”‚
 * â”‚ 1. æ£€æŸ¥ s_logging_is_enable (å¿…é¡»æ­£åœ¨ç›‘æ§)                  â”‚
 * â”‚ 2. æ£€æŸ¥ s_memory_dump_callback (é¿å…é‡å¤è°ƒç”¨)               â”‚
 * â”‚ 3. ä¿å­˜å‚æ•°: s_memory_dump_param = param                    â”‚
 * â”‚ 4. ä¿å­˜å›è°ƒ: s_memory_dump_callback = callback              â”‚
 * â”‚     â†“                                                       â”‚
 * â”‚ å†™å…¥çº¿ç¨‹: __memory_event_writing_thread()                   â”‚
 * â”‚     â†“                                                       â”‚
 * â”‚ 1. æ£€æµ‹åˆ° s_memory_dump_callback != NULL                    â”‚
 * â”‚ 2. è°ƒç”¨ generate_summary_report_i()                         â”‚
 * â”‚    - è¯»å– allocation_event_db.dat                           â”‚
 * â”‚    - è¯»å– stack_frames_db.dat                               â”‚
 * â”‚    - æŒ‰å †æ ˆåˆ†ç»„ï¼Œç»Ÿè®¡æ¯ä¸ªå †æ ˆçš„æ€»å¤§å°                         â”‚
 * â”‚    - ç”Ÿæˆ JSON æŠ¥å‘Š                                         â”‚
 * â”‚ 3. s_memory_dump_data = JSON æ•°æ®                           â”‚
 * â”‚ 4. å¯åŠ¨ dumping çº¿ç¨‹: __prepare_dumping_thread()            â”‚
 * â”‚     â†“                                                       â”‚
 * â”‚ Dumping çº¿ç¨‹: __memory_event_dumping_thread()               â”‚
 * â”‚     â†“                                                       â”‚
 * â”‚ 1. è°ƒç”¨ callback(data, size)                                â”‚
 * â”‚ 2. æ¸…ç†: s_memory_dump_data = NULL                          â”‚
 * â”‚ 3. æ¸…ç†: s_memory_dump_callback = NULL                      â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * æŠ¥å‘Šæ ¼å¼ï¼ˆJSONï¼‰ï¼š
 * {
 *   "head": {
 *     "phone": "iPhone14,2",
 *     "os_ver": "iOS 15.0",
 *     "launch_time": 1704067200000,
 *     "report_time": 1704070800000,
 *     "app_uuid": "ABC123...",
 *     "foom_scene": "manual_dump"
 *   },
 *   "items": [
 *     {
 *       "size": 10485760,        // æ€»å¤§å°ï¼ˆå­—èŠ‚ï¼‰
 *       "count": 1024,           // åˆ†é…æ¬¡æ•°
 *       "stacks": [              // è°ƒç”¨å †æ ˆ
 *         {"frames": [0x100001234, 0x100005678, ...]},
 *         ...
 *       ]
 *     },
 *     ...
 *   ]
 * }
 * 
 * å¤±è´¥åŸå› ï¼š
 * - è¿”å› false çš„æƒ…å†µï¼š
 *   Â· s_logging_is_enable == false (æœªå¯åŠ¨ç›‘æ§)
 *   Â· s_memory_dump_callback != NULL (ä¸Šæ¬¡ dump è¿˜æœªå®Œæˆ)
 * 
 * æ³¨æ„äº‹é¡¹ï¼š
 * - ä¸èƒ½è¿ç»­è°ƒç”¨ï¼Œå¿…é¡»ç­‰ä¸Šæ¬¡å®Œæˆ
 * - ç”ŸæˆæŠ¥å‘Šæœ‰ä¸€å®šè€—æ—¶ï¼ˆçº¦ 100-500msï¼‰
 * - callback åœ¨åå°çº¿ç¨‹ï¼ˆdumping threadï¼‰æ‰§è¡Œ
 * - ä¸ä¼šåœæ­¢ç›‘æ§ï¼Œå¯ä»¥å¤šæ¬¡è°ƒç”¨
 * 
 * ä½¿ç”¨ç¤ºä¾‹ï¼š
 * ```cpp
 * void my_callback(const char *data, size_t len) {
 *     NSData *reportData = [NSData dataWithBytes:data length:len];
 *     NSLog(@"ğŸ“Š æ”¶åˆ°æŠ¥å‘Š: %lu å­—èŠ‚", len);
 *     // å¤„ç†æŠ¥å‘Šæ•°æ®...
 * }
 * 
 * summary_report_param param;
 * param.phone = "iPhone14,2";
 * param.os_ver = "iOS 15.0";
 * param.launch_time = 1704067200000;
 * param.report_time = [[NSDate date] timeIntervalSince1970] * 1000;
 * param.app_uuid = "ABC123...";
 * param.foom_scene = "memory_warning";
 * 
 * if (memory_dump(my_callback, param)) {
 *     NSLog(@"âœ… å¼€å§‹ç”Ÿæˆå†…å­˜å¿«ç…§");
 * } else {
 *     NSLog(@"âŒ è§¦å‘å¤±è´¥ï¼ˆå¯èƒ½æ­£åœ¨ç”Ÿæˆä¸Šä¸€ä¸ªå¿«ç…§ï¼‰");
 * }
 * ```
 */
bool memory_dump(void (*callback)(const char *, size_t), summary_report_param param);
