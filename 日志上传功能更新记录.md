# 日志自动上报功能更新说明

## ✨ 新增功能

现在 MatrixTestApp 可以**自动将卡顿日志上报到符号化服务器**，无需手动导出日志文件！

## 🔄 工作流程

```
检测到卡顿 → 自动上报日志 → 服务器自动符号化 → Web界面查看结果
```

## 🚀 使用方法

### 1. 启动符号化服务

```bash
cd matrix-symbolicate-server
./start.sh
```

### 2. 配置服务器地址（真机测试需要）

#### 模拟器（默认）
无需配置，自动使用 `http://localhost:8080`

#### 真机测试
在 `MatrixTestApp/Info.plist` 中修改：

```xml
<key>MatrixServerURL</key>
<string>http://YOUR_MAC_IP:8080</string>
```

**如何获取 Mac IP 地址：**
```bash
# 在 Mac 终端执行
ifconfig | grep "inet " | grep -v 127.0.0.1
```

例如：`http://192.168.1.100:8080`

### 3. 运行应用并触发卡顿

1. 在 Xcode 中运行 MatrixTestApp (Cmd+R)
2. 点击「Matrix 功能演示」→「卡顿监控」→「模拟主线程卡顿」
3. **自动上报完成！** 查看 Xcode 控制台输出

### 4. 查看符号化结果

打开浏览器：`http://localhost:8080`
- 点击「📋 报告列表」标签
- 查看刚上报的日志
- 点击「查看」按钮查看符号化后的详细堆栈

## 📊 控制台输出说明

成功上报时会看到：
```
📤 开始上报日志到服务器: http://localhost:8080/api/report/upload
   文件名: lag_report_1703056825.json
   大小: 45.23 KB
✅ 日志上报成功！
   报告 ID: 1703056825123456789
   查看地址: http://localhost:8080/#reports
🔍 开始自动符号化...
✅ 符号化完成！可在 Web 界面查看详细报告
```

失败时会看到：
```
❌ 日志上报失败: The Internet connection appears to be offline.
   提示: 请确保符号化服务正在运行 (./start.sh)
```

## 🔧 代码修改详情

### MatrixHandler.mm

**新增方法：**
- `uploadReportToServer:` - 主上报方法
- `performUploadWithData:fileName:reportType:` - 执行 HTTP 上传
- `triggerSymbolicateForReportId:serverHost:` - 触发自动符号化
- `uploadFileToServer:withTitle:` - 手动上传文件（备用）

**修改位置：**
- `onReportIssue:` 方法中添加了自动上报调用

### Info.plist

**新增配置：**
- `MatrixServerURL` - 服务器地址配置（可在运行时修改）

## 🎯 特性

✅ **自动上报** - 检测到卡顿立即上报，无需手动操作
✅ **自动符号化** - 上报成功后自动触发符号化
✅ **后台执行** - 不阻塞主线程，不影响应用性能
✅ **智能重试** - 网络失败时记录错误，不会崩溃
✅ **配置灵活** - 支持模拟器和真机，可自定义服务器地址
✅ **详细日志** - 完整的上报和符号化过程日志

## 🔍 测试步骤

### 完整测试流程

**1. 准备环境**
```bash
# 启动服务器
cd matrix-symbolicate-server
./start.sh

# 上传符号表（一次性操作）
# 打开 http://localhost:8080
# 从 DerivedData 上传最新的 dSYM
```

**2. 运行应用**
```bash
# 在 Xcode 中运行
# 选择模拟器或真机
# Cmd+R
```

**3. 触发卡顿**
```
应用中操作：
Matrix 功能演示 → 卡顿监控 → 模拟主线程卡顿
```

**4. 查看结果**
```
Xcode 控制台：查看上报日志
浏览器：http://localhost:8080/#reports
```

## 💡 使用技巧

### 技巧 1：首次使用前上传 dSYM

```bash
# 编译应用后，立即获取并上传 dSYM
cd ~/Library/Developer/Xcode/DerivedData/MatrixTestApp-*/Build/Products/Debug-iphonesimulator/
zip -r ~/Desktop/symbols.dSYM.zip MatrixTestApp.app.dSYM

# 在 http://localhost:8080 上传
```

### 技巧 2：多设备测试

可以配置不同的服务器地址：
- 开发机：`http://localhost:8080`
- 测试机：`http://test-server.local:8080`
- 生产环境：`https://matrix.yourcompany.com`

只需修改 Info.plist 中的 `MatrixServerURL`。

### 技巧 3：离线保存 + 稍后上传

如果网络不可用，日志会先保存在本地：
```
Library/Caches/Matrix/CrashBlock/
```

可以稍后手动上传到服务器。

### 技巧 4：批量测试

```objective-c
// 在代码中多次触发卡顿
for (int i = 0; i < 5; i++) {
    // 触发卡顿
    [NSThread sleepForTimeInterval:3.1];
}
// 会生成多个报告并自动上报
```

## ⚠️ 注意事项

### 真机测试注意事项

1. **确保 Mac 和 iPhone 在同一网络**
   - 连接同一个 Wi-Fi
   - 或使用 USB 网络共享

2. **防火墙设置**
   ```bash
   # macOS 防火墙可能会阻止连接
   # 系统偏好设置 → 安全性与隐私 → 防火墙选项
   # 允许传入连接
   ```

3. **使用实际 IP 地址**
   ```bash
   # 获取 Mac IP
   ifconfig en0 | grep inet
   
   # 修改 Info.plist
   # http://192.168.1.100:8080
   ```

### 网络权限

Info.plist 中已配置：
```xml
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
    <key>NSAllowsLocalNetworking</key>
    <true/>
</dict>
```

### 性能影响

- 上报在后台线程执行，不影响主线程
- 仅在检测到卡顿时上报，正常使用无额外开销
- 网络失败不会重试，避免浪费资源

## 🐛 故障排查

### 问题：日志上报失败

**检查清单：**
1. ✅ 服务器是否运行？`curl http://localhost:8080/api/health`
2. ✅ 网络是否可达？`ping localhost`（模拟器）或 `ping MAC_IP`（真机）
3. ✅ 防火墙是否开启？
4. ✅ Info.plist 中的服务器地址是否正确？

### 问题：符号化失败

**检查清单：**
1. ✅ dSYM 是否已上传？访问 http://localhost:8080/#dsyms
2. ✅ dSYM 版本是否匹配？UUID 要一致
3. ✅ 应用是 Debug 模式编译？

### 问题：真机无法连接

**解决方案：**
```bash
# 1. 获取 Mac IP
ifconfig en0 | grep "inet "

# 2. 测试连接
# 在 iPhone Safari 中访问：http://MAC_IP:8080

# 3. 如果无法访问，检查防火墙
sudo pfctl -d  # 临时关闭防火墙测试
```

## 📚 相关文件

- `MatrixTestApp/Matrix/MatrixHandler.mm` - 上报逻辑实现
- `MatrixTestApp/Info.plist` - 服务器地址配置
- `matrix-symbolicate-server/` - 符号化服务代码

## 🎉 开始使用

现在就试试吧！

1. 启动服务器：`./matrix-symbolicate-server/start.sh`
2. 运行应用：Xcode Cmd+R
3. 触发卡顿：Matrix 功能演示 → 卡顿监控
4. 查看结果：http://localhost:8080

**享受自动化的便利！** 🚀

