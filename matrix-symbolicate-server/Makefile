.PHONY: help install run build clean test dev

# é»˜è®¤ç›®æ ‡
help:
	@echo "Matrix ç¬¦å·åŒ–æœåŠ¡ - Makefile"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make install    - å®‰è£…ä¾èµ–"
	@echo "  make run        - è¿è¡ŒæœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰"
	@echo "  make build      - ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶"
	@echo "  make clean      - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  make test       - è¿è¡Œæµ‹è¯•"
	@echo "  make dev        - å¯åŠ¨å¼€å‘æœåŠ¡ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰"
	@echo ""

# å®‰è£…ä¾èµ–
install:
	@echo "ðŸ“¦ å®‰è£… Go ä¾èµ–..."
	go mod download
	go mod tidy
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# è¿è¡ŒæœåŠ¡
run:
	@echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
	@mkdir -p uploads dsyms reports static
	go run .

# ç¼–è¯‘äºŒè¿›åˆ¶
build:
	@echo "ðŸ”¨ ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶..."
	@mkdir -p bin
	go build -o bin/matrix-server .
	@echo "âœ… ç¼–è¯‘å®Œæˆ: bin/matrix-server"

# æ¸…ç†æ–‡ä»¶
clean:
	@echo "ðŸ—‘ï¸  æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	rm -rf bin/
	rm -rf uploads/*
	rm -rf dsyms/*
	rm -rf reports/*
	@echo "âœ… æ¸…ç†å®Œæˆ"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ðŸ§ª è¿è¡Œæµ‹è¯•..."
	go test -v ./...

# å¼€å‘æ¨¡å¼ï¼ˆéœ€è¦å®‰è£… airï¼‰
dev:
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "âŒ è¯·å…ˆå®‰è£… air: go install github.com/cosmtrek/air@latest"; \
		echo "æˆ–ä½¿ç”¨: make run"; \
	fi

# æ£€æŸ¥çŽ¯å¢ƒ
check:
	@echo "ðŸ” æ£€æŸ¥çŽ¯å¢ƒ..."
	@command -v go >/dev/null 2>&1 || { echo "âŒ æœªæ‰¾åˆ° Go"; exit 1; }
	@command -v atos >/dev/null 2>&1 || { echo "âŒ æœªæ‰¾åˆ° atos"; exit 1; }
	@command -v dwarfdump >/dev/null 2>&1 || { echo "âŒ æœªæ‰¾åˆ° dwarfdump"; exit 1; }
	@echo "âœ… çŽ¯å¢ƒæ£€æŸ¥é€šè¿‡"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ðŸŽ¨ æ ¼å¼åŒ–ä»£ç ..."
	go fmt ./...
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆ"

# ä»£ç æ£€æŸ¥
lint:
	@echo "ðŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	@if command -v golangci-lint > /dev/null; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  æœªå®‰è£… golangci-lintï¼Œä½¿ç”¨ go vet"; \
		go vet ./...; \
	fi

# ç”Ÿäº§éƒ¨ç½²
deploy: build
	@echo "ðŸš€ å‡†å¤‡éƒ¨ç½²..."
	@mkdir -p deploy
	cp bin/matrix-server deploy/
	cp -r static deploy/
	@echo "âœ… éƒ¨ç½²æ–‡ä»¶å·²å‡†å¤‡åˆ° deploy/ ç›®å½•"

# æŸ¥çœ‹æ—¥å¿—ç›®å½•å¤§å°
du:
	@echo "ðŸ“Š å­˜å‚¨ä½¿ç”¨æƒ…å†µ:"
	@du -sh dsyms 2>/dev/null || echo "  dsyms: 0 B"
	@du -sh reports 2>/dev/null || echo "  reports: 0 B"
	@du -sh uploads 2>/dev/null || echo "  uploads: 0 B"

