# Matrix 卡顿日志符号化服务

一个基于 Go 语言的 Web 服务，用于上传、管理和符号化 Matrix 框架生成的卡顿日志。

## ✨ 功能特性

- 📦 **符号表管理**
  - 上传 dSYM 文件（.dSYM.zip 或 .app）
  - 自动提取 UUID 和架构信息
  - 符号表列表查看和删除

- 📋 **日志处理**
  - 上传卡顿日志（JSON 格式）
  - 自动匹配符号表
  - 一键符号化堆栈信息
  - 高亮应用代码位置

- 🎨 **现代化 UI**
  - 响应式设计
  - 拖拽上传
  - 实时进度显示
  - 报告预览

## 🚀 快速开始

### 前置要求

- Go 1.21 或更高版本
- macOS 系统（需要 `atos` 和 `dwarfdump` 命令）
- Xcode 命令行工具

### 安装依赖

```bash
cd matrix-symbolicate-server
go mod download
```

### 启动服务

```bash
go run main.go symbolicate.go
```

服务将在 `http://localhost:8080` 启动。

### 自定义端口

```bash
PORT=9000 go run main.go symbolicate.go
```

## 📖 使用指南

### 1. 准备符号表

从 Xcode 项目导出 dSYM：

```bash
# 方法1: 从 DerivedData 获取
cd ~/Library/Developer/Xcode/DerivedData/MatrixTestApp-*/Build/Products/Debug-iphonesimulator/
zip -r MatrixTestApp.dSYM.zip MatrixTestApp.app.dSYM

# 方法2: 直接使用 .app 文件
cp -r MatrixTestApp.app ~/Desktop/
```

### 2. 上传符号表

1. 打开 Web 界面：`http://localhost:8080`
2. 在「上传」标签页，点击或拖拽上传 dSYM 文件
3. 等待上传完成，系统会自动提取 UUID

### 3. 上传卡顿日志

1. 从应用获取卡顿日志（JSON 格式）
2. 在「上传」标签页，上传日志文件
3. 系统会自动匹配符号表并开始符号化

### 4. 查看报告

1. 在「报告列表」标签页查看所有报告
2. 点击「查看」按钮查看详细信息
3. 符号化后的报告会高亮显示应用代码位置

## 📁 项目结构

```
matrix-symbolicate-server/
├── main.go           # 主服务器和 API 路由
├── symbolicate.go    # 符号化核心逻辑
├── go.mod            # Go 模块配置
├── go.sum            # 依赖校验
├── README.md         # 项目文档
├── static/           # 前端静态文件
│   └── index.html    # Web 界面
├── uploads/          # 临时上传目录
├── dsyms/            # 符号表存储目录
└── reports/          # 报告存储目录
```

## 🔧 API 接口

### 符号表管理

- `POST /api/dsym/upload` - 上传符号表
- `GET /api/dsym/list` - 获取符号表列表
- `DELETE /api/dsym/:filename` - 删除符号表

### 报告管理

- `POST /api/report/upload` - 上传报告
- `POST /api/report/symbolicate` - 符号化报告
- `GET /api/report/list` - 获取报告列表
- `GET /api/report/:id` - 获取报告详情
- `DELETE /api/report/:id` - 删除报告

### 健康检查

- `GET /api/health` - 服务健康状态

## 💡 工作原理

### 符号化流程

1. **上传阶段**
   - 接收 dSYM 文件和卡顿日志
   - 提取 dSYM 的 UUID 和架构信息
   - 存储到本地目录

2. **匹配阶段**
   - 从日志中提取应用的 UUID
   - 在符号表列表中查找匹配的 dSYM
   - 自动关联对应的符号表

3. **符号化阶段**
   - 解析日志中的线程堆栈
   - 使用 `atos` 命令符号化每个地址
   - 提取文件名和行号信息
   - 标记应用代码和框架代码

4. **展示阶段**
   - 生成人类可读的报告
   - 高亮显示应用代码位置
   - 提供详细的堆栈信息

### 符号化示例

**符号化前：**
```
0  MatrixTestApp    0x102abc123
1  ???              0x103def456
```

**符号化后：**
```
👉 0  MatrixTestApp    0x102abc123
      -[TestLagViewController simulateLag] (TestLagViewController.mm:145)
   1  UIKit           0x103def456
      -[UIApplication sendAction:to:from:forEvent:]
```

## 🎯 最佳实践

### Debug 构建设置

确保 Xcode 项目的 Build Settings 正确配置：

```
Debug Information Format = DWARF with dSYM File
Strip Debug Symbols = NO (Debug 模式)
Generate Debug Symbols = YES
```

### 符号表版本管理

- 每次重新编译应用时重新上传 dSYM
- 保持符号表和日志的 UUID 匹配
- 定期清理过期的符号表

### 性能优化

- 大文件上传限制：500MB
- 符号化超时设置：5秒/地址
- 自动清理临时文件

## 🔍 故障排查

### 符号化失败

**问题：** 报告显示「未找到匹配的符号表」

**解决方案：**
1. 检查 dSYM 的 UUID 是否与报告匹配
2. 确认应用是 Debug 模式编译
3. 重新上传最新的 dSYM 文件

**问题：** 符号化后仍显示地址

**解决方案：**
1. 确认 dSYM 包含调试符号
2. 检查架构是否匹配（arm64 vs x86_64）
3. 验证 `atos` 命令是否可用：`which atos`

### 上传失败

**问题：** 文件上传失败

**解决方案：**
1. 检查文件大小是否超过限制
2. 确认文件格式正确（.dSYM.zip, .app, .json, .txt）
3. 查看服务器日志了解详细错误

## 🛠️ 开发指南

### 添加新功能

1. 在 `main.go` 中添加新的 API 路由
2. 在 `symbolicate.go` 中实现业务逻辑
3. 在 `static/index.html` 中更新前端界面

### 测试

```bash
# 运行服务
go run main.go symbolicate.go

# 健康检查
curl http://localhost:8080/api/health

# 上传测试
curl -X POST -F "file=@test.dSYM.zip" http://localhost:8080/api/dsym/upload
```

### 部署

```bash
# 编译二进制
go build -o matrix-server main.go symbolicate.go

# 运行
./matrix-server

# 后台运行
nohup ./matrix-server &
```

## 📝 日志格式

支持的卡顿日志格式参考：
https://raw.githubusercontent.com/wiki/Tencent/matrix/recource/block-killed-lag-sample.txt

关键字段：
- `system`: 系统信息（设备、OS版本、架构）
- `binary_images`: 加载的二进制镜像列表
- `crash.threads`: 线程堆栈信息
- `crash.threads[].backtrace.contents`: 堆栈帧数组

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 🔗 相关链接

- [Matrix iOS 框架](https://github.com/Tencent/matrix)
- [Gin Web 框架](https://github.com/gin-gonic/gin)
- [Apple 符号化文档](https://developer.apple.com/documentation/xcode/adding-identifiable-symbol-names-to-a-crash-report)

## 💬 技术支持

如有问题，请：
1. 查看本文档的故障排查部分
2. 检查服务器日志输出
3. 在项目中提交 Issue

---

**祝使用愉快！🎉**

