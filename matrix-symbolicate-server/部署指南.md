# éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨ä¸åŒç¯å¢ƒä¸­éƒ¨ç½² Matrix ç¬¦å·åŒ–æœåŠ¡ã€‚

## ğŸ–¥ï¸ æœ¬åœ°å¼€å‘éƒ¨ç½²

### å¿«é€Ÿå¯åŠ¨

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd matrix-symbolicate-server

# 2. å®‰è£…ä¾èµ–
make install

# 3. å¯åŠ¨æœåŠ¡
make run

# æˆ–ä½¿ç”¨å¯åŠ¨è„šæœ¬
./start.sh
```

æœåŠ¡å°†åœ¨ `http://localhost:8080` å¯åŠ¨ã€‚

### è‡ªå®šä¹‰é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cp config.example.env .env
# ç¼–è¾‘ .env æ–‡ä»¶ä¿®æ”¹é…ç½®
```

## ğŸ¢ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### æ–¹å¼ 1: ç›´æ¥è¿è¡ŒäºŒè¿›åˆ¶

```bash
# 1. ç¼–è¯‘
make build

# 2. å¤åˆ¶æ–‡ä»¶åˆ°æœåŠ¡å™¨
scp -r bin/matrix-server static/ user@server:/opt/matrix/

# 3. åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
ssh user@server
cd /opt/matrix
./matrix-server
```

### æ–¹å¼ 2: systemd æœåŠ¡

åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/matrix-symbolicate.service`:

```ini
[Unit]
Description=Matrix Symbolicate Service
After=network.target

[Service]
Type=simple
User=matrix
WorkingDirectory=/opt/matrix
ExecStart=/opt/matrix/bin/matrix-server
Restart=always
RestartSec=10

# ç¯å¢ƒå˜é‡
Environment="PORT=8080"
Environment="GIN_MODE=release"

# æ—¥å¿—
StandardOutput=journal
StandardError=journal
SyslogIdentifier=matrix-symbolicate

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š

```bash
# é‡è½½é…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start matrix-symbolicate

# å¼€æœºè‡ªå¯
sudo systemctl enable matrix-symbolicate

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status matrix-symbolicate

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u matrix-symbolicate -f
```

### æ–¹å¼ 3: Docker éƒ¨ç½²

åˆ›å»º `Dockerfile`:

```dockerfile
FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o matrix-server main.go symbolicate.go

FROM alpine:latest

# å®‰è£… Xcode å‘½ä»¤è¡Œå·¥å…·ï¼ˆä»…é€‚ç”¨äº macOS å®¿ä¸»æœºï¼‰
# æ³¨æ„: Docker éƒ¨ç½²éœ€è¦å®¿ä¸»æœºæ”¯æŒ atos å‘½ä»¤

RUN apk --no-cache add ca-certificates

WORKDIR /root/
COPY --from=builder /app/matrix-server .
COPY --from=builder /app/static ./static

RUN mkdir -p uploads dsyms reports

EXPOSE 8080

CMD ["./matrix-server"]
```

æ„å»ºå’Œè¿è¡Œï¼š

```bash
# æ„å»ºé•œåƒ
docker build -t matrix-symbolicate:latest .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name matrix-symbolicate \
  -p 8080:8080 \
  -v $(pwd)/dsyms:/root/dsyms \
  -v $(pwd)/reports:/root/reports \
  matrix-symbolicate:latest

# æŸ¥çœ‹æ—¥å¿—
docker logs -f matrix-symbolicate
```

### æ–¹å¼ 4: Docker Compose

åˆ›å»º `docker-compose.yml`:

```yaml
version: '3.8'

services:
  matrix-symbolicate:
    build: .
    ports:
      - "8080:8080"
    volumes:
      - ./dsyms:/root/dsyms
      - ./reports:/root/reports
      - ./uploads:/root/uploads
    environment:
      - PORT=8080
      - GIN_MODE=release
    restart: always
```

è¿è¡Œï¼š

```bash
docker-compose up -d
```

## ğŸŒ Nginx åå‘ä»£ç†

åˆ›å»º Nginx é…ç½® `/etc/nginx/sites-available/matrix`:

```nginx
upstream matrix_backend {
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name matrix.yourdomain.com;

    # æ—¥å¿—
    access_log /var/log/nginx/matrix-access.log;
    error_log /var/log/nginx/matrix-error.log;

    # ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 500M;

    # é™æ€æ–‡ä»¶
    location /static/ {
        alias /opt/matrix/static/;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # API ä»£ç†
    location / {
        proxy_pass http://matrix_backend;
        proxy_http_version 1.1;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
    }
}
```

å¯ç”¨é…ç½®ï¼š

```bash
sudo ln -s /etc/nginx/sites-available/matrix /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## ğŸ”’ HTTPS é…ç½®

ä½¿ç”¨ Let's Encryptï¼š

```bash
# å®‰è£… certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d matrix.yourdomain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. åº”ç”¨æ—¥å¿—

ä½¿ç”¨ logrotate ç®¡ç†æ—¥å¿—ï¼š

åˆ›å»º `/etc/logrotate.d/matrix`:

```
/var/log/matrix/*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 matrix matrix
    sharedscripts
    postrotate
        systemctl reload matrix-symbolicate
    endscript
}
```

### 2. ç›‘æ§æŒ‡æ ‡

ä½¿ç”¨ Prometheusï¼š

åœ¨ Go ä»£ç ä¸­æ·»åŠ ï¼š

```go
import "github.com/prometheus/client_golang/prometheus/promhttp"

r.GET("/metrics", gin.WrapH(promhttp.Handler()))
```

### 3. å¥åº·æ£€æŸ¥

```bash
# ç®€å•æ£€æŸ¥
curl http://localhost:8080/api/health

# ç›‘æ§è„šæœ¬
#!/bin/bash
while true; do
    if ! curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
        echo "æœåŠ¡å¼‚å¸¸ï¼Œå°è¯•é‡å¯..."
        systemctl restart matrix-symbolicate
    fi
    sleep 60
done
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### 1. Go è¿è¡Œæ—¶ä¼˜åŒ–

```bash
# è®¾ç½® GOMAXPROCS
export GOMAXPROCS=4

# è®¾ç½® GC ç™¾åˆ†æ¯”
export GOGC=100
```

### 2. æ–‡ä»¶æè¿°ç¬¦é™åˆ¶

ç¼–è¾‘ `/etc/security/limits.conf`:

```
matrix soft nofile 65536
matrix hard nofile 65536
```

### 3. ç£ç›˜ I/O ä¼˜åŒ–

ä½¿ç”¨ SSD å­˜å‚¨ dSYM å’ŒæŠ¥å‘Šæ–‡ä»¶ã€‚

## ğŸ” å®‰å…¨åŠ å›º

### 1. é˜²ç«å¢™é…ç½®

```bash
# UFW
sudo ufw allow 8080/tcp
sudo ufw enable

# iptables
sudo iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
```

### 2. ç”¨æˆ·æƒé™

```bash
# åˆ›å»ºä¸“ç”¨ç”¨æˆ·
sudo useradd -r -s /bin/false matrix

# è®¾ç½®ç›®å½•æƒé™
sudo chown -R matrix:matrix /opt/matrix
sudo chmod 750 /opt/matrix
```

### 3. è®¿é—®æ§åˆ¶

åœ¨ Nginx ä¸­æ·»åŠ åŸºæœ¬è®¤è¯ï¼š

```nginx
location / {
    auth_basic "Matrix Symbolicate";
    auth_basic_user_file /etc/nginx/.htpasswd;
    proxy_pass http://matrix_backend;
}
```

åˆ›å»ºå¯†ç æ–‡ä»¶ï¼š

```bash
sudo htpasswd -c /etc/nginx/.htpasswd admin
```

## ğŸ“¦ å¤‡ä»½ç­–ç•¥

### è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# /opt/matrix/backup.sh

BACKUP_DIR="/backup/matrix"
DATE=$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½ç¬¦å·è¡¨
tar -czf "$BACKUP_DIR/dsyms_$DATE.tar.gz" /opt/matrix/dsyms/

# å¤‡ä»½æŠ¥å‘Š
tar -czf "$BACKUP_DIR/reports_$DATE.tar.gz" /opt/matrix/reports/

# æ¸…ç† 30 å¤©å‰çš„å¤‡ä»½
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete

echo "å¤‡ä»½å®Œæˆ: $DATE"
```

æ·»åŠ åˆ° crontabï¼š

```bash
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½
0 2 * * * /opt/matrix/backup.sh
```

## ğŸ”„ æ›´æ–°å’Œç»´æŠ¤

### æ»šåŠ¨æ›´æ–°

```bash
# 1. ç¼–è¯‘æ–°ç‰ˆæœ¬
make build

# 2. å¤‡ä»½å½“å‰ç‰ˆæœ¬
cp bin/matrix-server bin/matrix-server.bak

# 3. å¤åˆ¶æ–°ç‰ˆæœ¬
cp bin/matrix-server /opt/matrix/

# 4. é‡å¯æœåŠ¡
sudo systemctl restart matrix-symbolicate

# 5. éªŒè¯
curl http://localhost:8080/api/health
```

### é›¶åœæœºæ›´æ–°

ä½¿ç”¨å¤šå®ä¾‹ + è´Ÿè½½å‡è¡¡ï¼š

```bash
# åœæ­¢å®ä¾‹ 1
sudo systemctl stop matrix-symbolicate@1

# æ›´æ–°å®ä¾‹ 1
cp bin/matrix-server /opt/matrix/instance1/

# å¯åŠ¨å®ä¾‹ 1
sudo systemctl start matrix-symbolicate@1

# ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡

# é‡å¤ä»¥ä¸Šæ­¥éª¤æ›´æ–°å®ä¾‹ 2
```

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. æœåŠ¡æ— æ³•å¯åŠ¨**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo lsof -i :8080

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u matrix-symbolicate -n 100
```

**2. ç¬¦å·åŒ–å¤±è´¥**
```bash
# æ£€æŸ¥ atos æ˜¯å¦å¯ç”¨
which atos

# æ£€æŸ¥æƒé™
ls -la /opt/matrix/dsyms/
```

**3. å†…å­˜ä¸è¶³**
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# è°ƒæ•´ Go GC
export GOGC=50
```

## ğŸ“ˆ æ‰©å±•éƒ¨ç½²

### å¤šå®ä¾‹éƒ¨ç½²

```
         Load Balancer (HAProxy/Nginx)
                 /     \
                /       \
         Instance 1   Instance 2
               \         /
                \       /
            Shared Storage (NFS)
```

HAProxy é…ç½®ï¼š

```
backend matrix_backend
    balance roundrobin
    server server1 10.0.0.1:8080 check
    server server2 10.0.0.2:8080 check
```

## ğŸ“š ç›¸å…³èµ„æº

- [Gin æ¡†æ¶æ–‡æ¡£](https://gin-gonic.com/)
- [Go æ€§èƒ½ä¼˜åŒ–](https://golang.org/doc/effective_go)
- [Nginx é…ç½®å‚è€ƒ](https://nginx.org/en/docs/)
- [systemd æœåŠ¡ç®¡ç†](https://www.freedesktop.org/software/systemd/man/systemd.service.html)

---

**æœ‰é—®é¢˜ï¼Ÿ** æŸ¥çœ‹ä¸» README.md æˆ–æäº¤ Issueã€‚

