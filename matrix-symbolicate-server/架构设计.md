# 架构设计文档

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                         Web 浏览器                           │
│                     (React/HTML5 前端)                       │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP/JSON
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                     Gin Web 框架                             │
│                    (Go HTTP Server)                          │
├─────────────────────────────────────────────────────────────┤
│                      API 路由层                              │
│  ┌──────────────┬──────────────┬────────────────┐          │
│  │ 符号表管理   │  报告管理    │   符号化服务   │          │
│  └──────────────┴──────────────┴────────────────┘          │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                    业务逻辑层                                │
│  ┌──────────────────────────────────────────────┐          │
│  │  符号化引擎 (symbolicate.go)                 │          │
│  │  - UUID 匹配                                  │          │
│  │  - 地址解析                                   │          │
│  │  - 堆栈符号化                                 │          │
│  └──────────────────────────────────────────────┘          │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                   系统工具层                                 │
│  ┌───────────┬───────────┬──────────────┐                  │
│  │   atos    │ dwarfdump │   unzip      │                  │
│  │ (符号化)  │ (UUID提取)│  (解压)      │                  │
│  └───────────┴───────────┴──────────────┘                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                     存储层                                   │
│  ┌──────────┬──────────────┬─────────────────┐            │
│  │  dsyms/  │   reports/   │    uploads/     │            │
│  │ (符号表) │   (报告)     │   (临时文件)    │            │
│  └──────────┴──────────────┴─────────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. Web 服务层 (main.go)

**职责：**
- HTTP 服务器初始化
- 路由配置和分发
- 中间件管理（CORS、日志等）
- 文件上传处理

**关键 API：**
```
POST   /api/dsym/upload          - 上传符号表
GET    /api/dsym/list            - 列出符号表
DELETE /api/dsym/:uuid           - 删除符号表

POST   /api/report/upload        - 上传报告
POST   /api/report/symbolicate   - 符号化报告
GET    /api/report/list          - 列出报告
GET    /api/report/:id           - 获取报告详情
DELETE /api/report/:id           - 删除报告
```

### 2. 符号化引擎 (symbolicate.go)

**核心功能：**

#### 2.1 dSYM 信息提取
```go
extractDsymInfo(dsymPath) -> (uuid, arch, error)
```
- 支持 .app、.dSYM.zip 格式
- 使用 dwarfdump 提取 UUID
- 识别架构（arm64/x86_64）

#### 2.2 符号表匹配
```go
findMatchingDsym(report) -> dsymPath
```
- 从报告中提取应用 UUID
- 在符号表库中查找匹配项
- 自动关联最佳匹配

#### 2.3 地址符号化
```go
symbolicateAddress(binary, loadAddr, targetAddr, arch) -> symbol
```
- 调用 atos 命令
- 传递正确的加载地址和架构
- 解析符号化输出

#### 2.4 堆栈符号化
```go
symbolicateReport(report, dsymPath) -> symbolicatedReport
```
- 遍历所有线程
- 符号化每个栈帧
- 标记应用代码
- 生成完整报告

### 3. 前端界面 (static/index.html)

**功能模块：**

#### 3.1 上传模块
- 拖拽上传支持
- 文件类型验证
- 进度显示
- 上传后自动符号化

#### 3.2 管理模块
- 符号表列表
- 报告列表
- 文件删除
- 状态显示

#### 3.3 查看模块
- JSON 报告预览
- 代码高亮
- 应用代码标记
- 模态框展示

## 数据流

### 符号化流程

```
1. 用户上传 dSYM
   └─> 保存到 dsyms/
   └─> 提取 UUID
   └─> 返回确认

2. 用户上传报告
   └─> 保存到 reports/
   └─> 返回报告 ID

3. 触发符号化
   └─> 解析报告 JSON
   └─> 提取应用 UUID
   └─> 查找匹配的 dSYM
   └─> 遍历线程堆栈
       └─> 对每个地址调用 atos
       └─> 解析符号和行号
       └─> 标记应用代码
   └─> 生成符号化报告
   └─> 保存到 reports/*_symbolicated.json

4. 展示结果
   └─> 返回符号化后的 JSON
   └─> 前端格式化显示
   └─> 高亮应用代码
```

## 文件存储结构

```
matrix-symbolicate-server/
├── dsyms/                      # 符号表存储
│   ├── 20231220_143025_MatrixTestApp.dSYM.zip
│   ├── 20231221_100000_MatrixTestApp.app
│   └── ...
│
├── reports/                    # 报告存储
│   ├── 1703056825_lag_report.json                  # 原始报告
│   ├── 1703056825_lag_report_symbolicated.json     # 符号化后
│   └── ...
│
├── uploads/                    # 临时上传目录
│   └── (临时文件，处理后删除)
│
└── static/                     # 前端资源
    └── index.html
```

## 关键算法

### UUID 匹配算法

```
输入: 报告 JSON
输出: 匹配的 dSYM 路径

1. 从报告的 binary_images 中找到应用镜像
2. 提取应用的 UUID（如 FD7CB3D0-...）
3. 遍历 dsyms/ 目录中的所有文件
4. 对每个文件提取 UUID
5. 比较 UUID（不区分大小写）
6. 返回匹配的第一个文件
7. 如果没有匹配，返回空
```

### 符号化优化策略

**地址范围判断：**
- 仅符号化应用地址空间内的地址
- 跳过明显的系统库地址

**批量处理：**
- 收集所有需要符号化的地址
- 批量调用 atos（减少进程创建开销）

**缓存机制：**
- 对相同地址的符号化结果缓存
- 避免重复调用 atos

**超时控制：**
- 每个 atos 调用限时 5 秒
- 防止卡死

## 性能优化

### 1. 并发处理
```go
// 并行符号化多个线程
var wg sync.WaitGroup
for _, thread := range threads {
    wg.Add(1)
    go func(t Thread) {
        defer wg.Done()
        symbolicateThread(t, ...)
    }(thread)
}
wg.Wait()
```

### 2. 流式处理
- 大文件使用流式读取
- 避免一次性加载到内存

### 3. 索引优化
- dSYM UUID 索引
- 快速查找匹配项

## 安全考虑

### 1. 文件上传
- 文件大小限制（500MB）
- 文件类型白名单
- 文件名清理（防止路径穿越）

### 2. 命令注入防护
- 所有外部命令参数经过验证
- 使用 exec.Command 而非 shell

### 3. 访问控制
- CORS 配置
- 可选的认证中间件

## 扩展性设计

### 1. 存储后端可插拔
```go
type Storage interface {
    SaveDsym(file) error
    LoadDsym(uuid) ([]byte, error)
    DeleteDsym(uuid) error
}

// 当前: 本地文件系统
// 未来: S3, OSS, 数据库等
```

### 2. 符号化引擎可扩展
```go
type Symbolicator interface {
    Symbolicate(addr, loadAddr) (string, error)
}

// 当前: atos
// 未来: lldb, 自定义解析器等
```

### 3. 消息队列集成
```
用户上传 -> 放入队列 -> 异步符号化 -> WebSocket 推送结果
```

## 监控和日志

### 日志级别
- INFO: 正常操作（上传、符号化完成）
- WARN: 可恢复错误（UUID 不匹配）
- ERROR: 严重错误（符号化失败）

### 关键指标
- 上传成功率
- 符号化成功率
- 平均符号化时间
- 存储使用量

## 部署架构

### 单机部署
```
Nginx (可选) -> Go Server -> 本地文件系统
```

### 分布式部署
```
Load Balancer -> [Go Server 1, Go Server 2, ...] -> 共享存储 (NFS/S3)
```

## 技术栈

- **后端**: Go 1.21+
- **Web 框架**: Gin
- **前端**: HTML5 + Vanilla JavaScript
- **存储**: 文件系统
- **系统工具**: atos, dwarfdump (Xcode 自带)

## 未来改进方向

1. **认证和权限**
   - 用户登录
   - 团队/项目隔离
   - API Key 支持

2. **高级功能**
   - 符号表版本管理
   - 报告对比分析
   - 性能趋势图表
   - 自动告警

3. **集成能力**
   - CI/CD 插件
   - Webhook 通知
   - Slack/钉钉集成

4. **性能优化**
   - 符号化结果缓存
   - dSYM 索引数据库
   - 分布式符号化

---

**文档版本**: 1.0  
**最后更新**: 2023-12-22

